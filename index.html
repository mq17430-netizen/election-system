<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f4f6fb;
            min-height: 100vh;
        }

        /* ====== ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====== */

        #loginSection {
            min-height: 100vh;
            display: none;   /* Ù†Ø®ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 18px 40px rgba(15,34,58,0.18);
            max-width: 380px;
            width: 100%;
            padding: 26px 24px 20px;
            text-align: center;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #fff;
            background: linear-gradient(135deg, #00c853, #1a9bff);
        }

        .login-card h1 {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .login-subtitle {
            font-size: 13px;
            color: #777;
            margin-bottom: 16px;
        }

        .login-form-group {
            text-align: right;
            margin-bottom: 12px;
        }

        .login-form-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #555;
        }

        .login-form-group input {
            width: 100%;
            padding: 9px 10px;
            border-radius: 10px;
            border: 1px solid #dde2ef;
            font-size: 13px;
            outline: none;
        }

        .login-form-group input:focus {
            border-color: #1a9bff;
            box-shadow: 0 0 0 3px rgba(26, 155, 255, 0.12);
        }

        .login-btn {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 10px 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, #00c853, #1a9bff, #0066ff);
            color: #fff;
            box-shadow: 0 10px 22px rgba(0,102,255,0.25);
            margin-top: 4px;
        }

        .login-error {
            margin-top: 8px;
            font-size: 12px;
            color: #c62828;
            display: none;
        }

        .login-hint {
            margin-top: 10px;
            font-size: 11px;
            color: #888;
            text-align: right;
            line-height: 1.5;
        }

        .login-footer {
            margin-top: 14px;
            font-size: 11px;
            color: #999;
            text-align: center;
            line-height: 1.6;
        }

        /* ====== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© ====== */

        #dashboardSection {
            display: none;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 20px 40px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .top-left a {
            font-size: 13px;
            text-decoration: none;
            color: #555;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .top-left a:hover {
            text-decoration: underline;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00c853, #1a9bff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-info .title {
            font-size: 15px;
            font-weight: 700;
        }

        .user-info .welcome {
            font-size: 12px;
            color: #777;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(15, 34, 58, 0.08);
            padding: 14px 16px;
            margin-bottom: 14px;
        }

        .tabs {
            display: flex;
            gap: 18px;
            font-size: 13px;
            border-bottom: 1px solid #e3e6f0;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .tab {
            cursor: pointer;
            padding-bottom: 6px;
        }

        .tab.active {
            color: #00897b;
            border-bottom: 2px solid #00c853;
            font-weight: 600;
        }

        .tab:not(.active) {
            color: #777;
        }

        .search-box {
            margin-top: 10px;
        }

        .search-input {
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border-radius: 10px;
            border: 1px solid #e0e4f0;
            font-size: 13px;
            outline: none;
        }

        .search-input input:focus {
            border-color: #1a9bff;
            box-shadow: 0 0 0 3px rgba(26, 155, 255, 0.12);
        }

        .search-input span {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9aa4bc;
            font-size: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 14px 2px 8px;
        }

        .section-header h2 {
            font-size: 15px;
            font-weight: 700;
        }

        .add-bar {
            margin-top: 4px;
            background: linear-gradient(90deg, #00c853, #1a9bff, #0066ff);
            border-radius: 14px;
            padding: 10px 18px;
            color: #fff;
            font-size: 13px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 128, 255, 0.25);
        }

        .add-bar span.plus {
            font-size: 18px;
            margin-top: -2px;
        }

        .table-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(15, 34, 58, 0.08);
            margin-top: 10px;
            padding: 10px 12px;
        }

        .table-header,
        .table-row {
            display: grid;
            grid-template-columns: 1.3fr 1.2fr 1.1fr 0.9fr 0.9fr 0.9fr 0.9fr 1fr 0.9fr 0.9fr;
            gap: 4px;
            align-items: center;
        }

        .table-header {
            font-size: 11px;
            color: #777;
            border-bottom: 1px solid #edf0f7;
            padding-bottom: 6px;
            margin-bottom: 4px;
        }

        .table-row {
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #f1f3fb;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .monitor-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .monitor-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a9bff, #00c853);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 15px;
        }

        .monitor-name small {
            font-size: 10px;
            color: #888;
        }

        .badge-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
        }

        .badge-status.online {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-status.offline {
            background: #ffeaea;
            color: #c62828;
        }

        .bool-icon {
            font-size: 16px;
            cursor: pointer;
        }

        .bool-icon.true { color: #2e7d32; }
        .bool-icon.false { color: #c62828; }
        .bool-icon.neutral { color: #9e9e9e; }

        .actions {
            display: flex;
            justify-content: center;
            gap: 6px;
            font-size: 16px;
        }

        .actions span { cursor: pointer; }

        .no-data {
            text-align: center;
            font-size: 12px;
            color: #888;
            padding: 8px 0;
        }

        #mapSection iframe {
            width: 100%;
            height: 420px;
            border: 0;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(15, 34, 58, 0.12);
        }

        .report-item {
            padding: 8px 10px;
            border-radius: 10px;
            background: #fff;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(15,34,58,0.06);
            font-size: 13px;
        }

        .report-item-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .report-item small {
            color: #777;
            font-size: 11px;
        }

        .reports-summary {
            display: grid;
            grid-template-columns: repeat(3, minmax(0,1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .summary-box {
            background: #fff;
            border-radius: 14px;
            padding: 10px 12px;
            box-shadow: 0 6px 14px rgba(15,34,58,0.06);
            font-size: 13px;
        }

        .summary-title {
            font-size: 12px;
            color: #777;
        }

        .summary-value {
            margin-top: 4px;
            font-size: 20px;
            font-weight: 700;
            color: #244673;
        }

        .summary-note {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 16px 18px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .modal-header h3 { font-size: 15px; }
        .modal-close { cursor: pointer; font-size: 18px; }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 3px;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #dde2ef;
            font-size: 13px;
            outline: none;
        }

        .form-group input:focus {
            border-color: #1a9bff;
            box-shadow: 0 0 0 3px rgba(26, 155, 255, 0.1);
        }

        .modal button {
            border: none;
            border-radius: 12px;
            padding: 9px 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            background: linear-gradient(90deg, #00c853, #1a9bff, #0066ff);
            color: #fff;
            box-shadow: 0 8px 18px rgba(0, 102, 255, 0.25);
        }

        @media (max-width: 900px) {
            .table-header,
            .table-row { font-size: 10px; }
        }

        @media (max-width: 600px) {
            .table-header,
            .table-row {
                grid-template-columns: 1.4fr 1.4fr 1.2fr 1fr;
                grid-auto-rows: auto;
                row-gap: 4px;
            }

            .reports-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- ====== ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====== -->
<div id="loginSection">
    <div class="login-card">
        <div class="login-icon">ğŸ”</div>
        <h1>Ø¯Ø®ÙˆÙ„ Ù…Ø¯ÙŠØ± / Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
        <p class="login-subtitle">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù‡ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±.</p>

        <form id="loginForm">
            <div class="login-form-group">
                <label for="loginUser">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="loginUser" placeholder="Ù…Ø«Ø§Ù„: basim01">
            </div>
            <div class="login-form-group">
                <label for="loginPass">Ø§Ù„ÙƒÙˆØ¯ / ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPass" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù…ØªÙ‡ Ù…Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬">
            </div>
            <button type="submit" class="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="loginError" class="login-error"></div>
        </form>

        <div class="login-hint">
            * Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ù† Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†).<br>
            * Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·.
        </div>

        <div class="login-footer">
            ÙÙƒØ±Ø© ÙˆØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØ§Ø± Ù‚Ø§Ø³Ù…<br>
            07740707073
        </div>
    </div>
</div>

<!-- ====== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) ====== -->
<div id="dashboardSection">
    <div class="page">
        <div class="top-bar">
            <div class="top-left">
                <a href="#" id="logoutLink">â¬… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            </div>
            <div class="top-right">
                 <div class="user-info">
                    <div class="title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                    <div class="welcome">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="currentUserLabel">Ù…Ø³ØªØ®Ø¯Ù…</span></div>
                </div>
                <div class="user-icon">ğŸ‘¤</div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <div class="tab active" data-target="monitorsSection">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†</div>
                <div class="tab" data-target="mapSection">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</div>
                <div class="tab" data-target="reportsSection">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            </div>

            <div class="search-box" id="searchBox">
                <div class="search-input">
                    <input id="searchInput" type="text" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
                    <span>ğŸ”</span>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† -->
        <section id="monitorsSection">
            <div class="section-header">
                <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†</h2>
                <!-- Ø²Ø± Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† -->
                <button id="deleteAllMonitorsBtn"
                        type="button"
                        style="border:none;border-radius:10px;padding:6px 10px;font-size:11px;cursor:pointer;background:#e53935;color:#fff;box-shadow:0 2px 6px rgba(229,57,53,0.35);">
                    ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
                </button>
            </div>

            <div class="add-bar" id="addMonitorBtn">
                <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨</span>
                <span class="plus">+</span>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</div>
                    <div>Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹</div>
                    <div>ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                    <div>ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„</div>
                    <div>ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª</div>
                    <div>ØªÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø©</div>
                    <div>Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div>ØµÙˆØ±Ø© Ø§Ù„Ø´Ø±ÙŠØ·</div>
                    <div>Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                    <div>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                </div>
                <div id="monitorsBody"></div>
                <div id="noMonitors" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø¨Ø¹Ø¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨".</div>
            </div>
        </section>

        <!-- ØªØ¨ÙˆÙŠØ¨: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
        <section id="mapSection" style="display:none;">
            <div class="section-header">
                <h2>Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h2>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <iframe
                    id="mainMap"
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387190.2799130295!2d-74.25987368789875!3d40.69767006795592!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2z2YXYs9iq2Kog2KfZhNi52LXZitip!5e0!3m2!1sar!2s!4v1700000000000"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
            <p style="font-size:11px; color:#777; margin-top:6px;">
                * ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØªÙ… Ø±Ø¨Ø· Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø¨Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ù‡ÙˆØ§ØªÙÙ‡Ù….
            </p>
        </section>

        <!-- ØªØ¨ÙˆÙŠØ¨: Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <section id="reportsSection" style="display:none;">
            <div class="section-header">
                <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†</h2>
            </div>

            <div class="reports-summary">
                <div class="summary-box">
                    <div class="summary-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†</div>
                    <div class="summary-value" id="totalMonitorsCount">0</div>
                    <div class="summary-note">Ø¹Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©.</div>
                </div>
                <div class="summary-box">
                    <div class="summary-title">Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙˆÙ† Ø§Ù„Ø§ØµÙ„ÙˆÙ†</div>
                    <div class="summary-value" id="arrivedMonitorsCount">0</div>
                    <div class="summary-note">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ù… ÙƒÙ€ "ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„".</div>
                </div>
                <div class="summary-box">
                    <div class="summary-title">Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø¨Ù„Ù‘ÙØºØ©</div>
                    <div class="summary-value" id="issuesMonitorsCount">0</div>
                    <div class="summary-note">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ù…Ø´Ø§ÙƒÙ„ Ù…Ø¹Ù„Ù‘Ù…Ø©.</div>
                </div>
            </div>

            <div id="reportsList"></div>
            <div id="noReports" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
        </section>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨ -->
<div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
        <div class="modal-header">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ù‚Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <span class="modal-close" id="modalClose">âœ–</span>
        </div>
        <form id="addMonitorForm">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</label>
                <input type="text" id="monitorName" required>
            </div>
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" id="monitorPhone" required>
            </div>
            <div class="form-group">
                <label>Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹</label>
                <input type="text" id="monitorCenter" required>
            </div>
            <div class="form-group">
                <label>ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠÙØ³Ù„Ù‘Ù… Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨)</label>
                <input type="text" id="monitorCode" required>
            </div>
            <button type="submit">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</button>
        </form>
    </div>
</div>

<!-- Firebase (Compat SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
        authDomain: "election-system-9cbb8.firebaseapp.com",
        projectId: "election-system-9cbb8",
        storageBucket: "election-system-9cbb8.firebasestorage.app",
        messagingSenderId: "886706894008",
        appId: "1:886706894008:web:270556771843614e56b04d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const loginSection     = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const loginForm        = document.getElementById('loginForm');
    const loginError       = document.getElementById('loginError');
    const logoutLink       = document.getElementById('logoutLink');
    const currentUserLabel = document.getElementById('currentUserLabel');

    const monitorsBody = document.getElementById('monitorsBody');
    const noMonitors   = document.getElementById('noMonitors');
    const reportsList  = document.getElementById('reportsList');
    const noReports    = document.getElementById('noReports');
    const deleteAllMonitorsBtn = document.getElementById('deleteAllMonitorsBtn');

    const totalMonitorsCount  = document.getElementById('totalMonitorsCount');
    const arrivedMonitorsCount= document.getElementById('arrivedMonitorsCount');
    const issuesMonitorsCount = document.getElementById('issuesMonitorsCount');

    let currentUserName = null;
    let STORAGE_KEY     = null;
    let monitors        = [];

    function showLogin() {
        loginSection.style.display = 'flex';
        dashboardSection.style.display = 'none';
    }

    function showDashboard() {
        loginSection.style.display = 'none';
        dashboardSection.style.display = 'block';
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù…Ù† Firestore Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø©)
    function loadMonitorsFromFirestore() {
        if (!currentUserName) return;

        db.collection('monitors')
          .where('adminUsername', '==', currentUserName)
          .get()
          .then((snapshot) => {
              const loaded = [];
              snapshot.forEach((docu) => {
                  const data = docu.data();
                  loaded.push({
                      id:       docu.id,
                      name:     data.monitorName  || '',
                      phone:    data.monitorPhone || '',
                      center:   data.monitorCenter|| '',
                      code:     data.code || data.monitorCode || '',
                      arrived:  !!data.arrived,
                      voted:    !!data.voted,
                      hasIssue: !!data.hasIssue,
                      issueText: data.issueText || '',
                      online:   !!data.online,
                      location: data.location || null,
                      photos:   Array.isArray(data.photos) ? data.photos : []
                  });
              });
              monitors = loaded;
              saveMonitors();
              renderMonitors(document.getElementById('searchInput').value);
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù…Ù† Firestore:", err);
          });
    }

    function initForUser(username) {
        currentUserName = username;
        currentUserLabel.textContent = username;
        STORAGE_KEY = 'monitors_' + currentUserName;

        try {
            monitors = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        } catch (e) {
            monitors = [];
        }

        renderMonitors();
        loadMonitorsFromFirestore();
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Firestore (systemUsers) Ù…Ø¹ ÙØ­Øµ active
    loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        loginError.style.display = 'none';

        const username = document.getElementById('loginUser').value.trim();
        const pass     = document.getElementById('loginPass').value.trim();

        if (!username || !pass) {
            loginError.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒÙˆØ¯.';
            loginError.style.display = 'block';
            return;
        }

        db.collection('systemUsers')
          .where('username', '==', username)
          .where('password', '==', pass)
          .get()
          .then((snapshot) => {
              if (snapshot.empty) {
                  loginError.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·Ø§Ùƒ Ø¥ÙŠØ§Ù‡ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.';
                  loginError.style.display = 'block';
                  return;
              }

              let matchedUser = null;
              snapshot.forEach((docu) => {
                  const data = docu.data();
                  matchedUser = {
                      id: docu.id,
                      username: data.username,
                      password: data.password,
                      note: data.note || '',
                      active: (typeof data.active === 'boolean') ? data.active : true
                  };
              });

              if (!matchedUser) {
                  loginError.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….';
                  loginError.style.display = 'block';
                  return;
              }

              if (matchedUser.active === false) {
                  loginError.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.';
                  loginError.style.display = 'block';
                  return;
              }

              localStorage.setItem('currentUserName', matchedUser.username);
              initForUser(matchedUser.username);
              showDashboard();
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Firestore:", err);
              loginError.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
              loginError.style.display = 'block';
          });
    });

    logoutLink.addEventListener('click', function (e) {
        e.preventDefault();
        localStorage.removeItem('currentUserName');
        currentUserName = null;
        STORAGE_KEY = null;
        monitors = [];
        showLogin();
    });

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            const target = tab.dataset.target;
            document.getElementById('monitorsSection').style.display = (target === 'monitorsSection') ? 'block' : 'none';
            document.getElementById('mapSection').style.display      = (target === 'mapSection') ? 'block' : 'none';
            document.getElementById('reportsSection').style.display  = (target === 'reportsSection') ? 'block' : 'none';

            document.getElementById('searchBox').style.display       = (target === 'monitorsSection') ? 'block' : 'none';
        });
    });

    function saveMonitors() {
        if (!STORAGE_KEY) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(monitors));
    }

    function updateReportsSummary() {
        if (!totalMonitorsCount) return;
        const total   = monitors.length;
        const arrived = monitors.filter(m => m.arrived).length;
        const issues  = monitors.filter(m => m.hasIssue).length;

        totalMonitorsCount.textContent   = total;
        arrivedMonitorsCount.textContent = arrived;
        issuesMonitorsCount.textContent  = issues;
    }

    function getMonitorPhotosFromLocal(code) {
        const photos = [];
        const baseKey = "monitor_photo_" + code;

        const single = localStorage.getItem(baseKey);
        if (single) photos.push(single);

        for (let i = 1; i <= 20; i++) {
            const dataUrl = localStorage.getItem(baseKey + "_" + i);
            if (dataUrl) photos.push(dataUrl);
        }

        return photos;
    }

    function renderMonitors(filterText = '') {
        monitorsBody.innerHTML = '';

        const normalized = filterText.trim().toLowerCase();
        const filtered = monitors.filter(m => {
            if (!normalized) return true;
            const hay = (m.name + ' ' + m.phone + ' ' + m.center).toLowerCase();
            return hay.includes(normalized);
        });

        noMonitors.style.display = filtered.length === 0 ? 'block' : 'none';

        filtered.forEach((m, idx) => {
            const row = document.createElement('div');
            row.className = 'table-row';

            row.innerHTML = `
                <div class="monitor-name">
                    <div class="monitor-avatar">${m.name ? m.name.charAt(0) : '?'}</div>
                    <div>
                        <div>${m.name || '-'}</div>
                        <small>${m.phone || ''}</small>
                    </div>
                </div>

                <div>${m.center || '-'}</div>

                <div>
                    <code style="background:#f1f3fa; padding:2px 6px; border-radius:6px; font-size:11px;">${m.code || '-'}</code>
                </div>

                <div>
                    <span class="bool-icon ${m.arrived ? 'true' : 'false'}" data-action="toggleArrived" data-index="${idx}">${m.arrived ? 'âœ”' : 'âœ–'}</span>
                </div>

                <div>
                    <span class="bool-icon ${m.voted ? 'true' : 'false'}" data-action="toggleVoted" data-index="${idx}">${m.voted ? 'âœ”' : 'âœ–'}</span>
                </div>

                <div>
                    <span
                        class="bool-icon ${m.hasIssue ? 'true' : 'neutral'}"
                        data-action="viewIssue"
                        data-index="${idx}"
                        title="${m.hasIssue ? 'ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¨Ù„Ù‘ÙØºØ© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ØŒ Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¨Ù„Ù‘ÙØºØ© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨'}"
                    >
                        ${m.hasIssue ? 'âš ' : 'â€”'}
                    </span>
                </div>

                <div>
                    <span class="badge-status ${m.online ? 'online' : 'offline'}" data-action="toggleOnline" data-index="${idx}">
                        ${m.online ? 'ğŸ“¶ Ù…ØªØµÙ„' : 'ğŸ“¶ ØºÙŠØ± Ù…ØªØµÙ„'}
                    </span>
                </div>

                <div>
                    <button type="button"
                            data-action="viewPhotos"
                            data-index="${idx}"
                            style="font-size:11px; padding:3px 8px; border-radius:6px; border:1px solid #dde2ef; background:#f9fafc; cursor:pointer;">
                        Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
                    </button>
                </div>

                <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
                <div>
                    <span title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹" data-action="showLocation" data-index="${idx}">ğŸ“</span>
                </div>

                <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                <div class="actions">
                    <span title="Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨" data-action="deleteMonitor" data-index="${idx}">ğŸ—‘ï¸</span>
                </div>
            `;

            monitorsBody.appendChild(row);
        });

        renderReports();
        updateReportsSummary();
    }

    function renderReports() {
        reportsList.innerHTML = '';
        const troubled = monitors.filter(m => m.hasIssue && m.issueText);
        if (troubled.length === 0) {
            noReports.style.display = 'block';
            return;
        }
        noReports.style.display = 'none';

        troubled.forEach(m => {
            const div = document.createElement('div');
            div.className = 'report-item';
            div.innerHTML = `
                <div class="report-item-title">Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨: ${m.name}</div>
                <div style="font-size:12px; margin-bottom:3px;">Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹: ${m.center}</div>
                <div>${m.issueText}</div>
                <small>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${m.phone} â€“ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${m.code}</small>
            `;
            reportsList.appendChild(div);
        });
    }

    document.getElementById('searchInput').addEventListener('input', function () {
        renderMonitors(this.value);
    });

    const modalBackdrop = document.getElementById('modalBackdrop');
    const addMonitorBtn = document.getElementById('addMonitorBtn');
    const modalClose    = document.getElementById('modalClose');
    const addMonitorForm= document.getElementById('addMonitorForm');

    function generateMonitorCode() {
        const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        const digits  = "0123456789";
        let code = "";
        for (let i = 0; i < 4; i++) {
            code += letters[Math.floor(Math.random() * letters.length)];
        }
        code += digits[Math.floor(Math.random() * digits.length)];
        return code;
    }

    function openModal() {
        document.getElementById('monitorCode').value = generateMonitorCode();
        modalBackdrop.style.display = 'flex';
    }
    function closeModal() {
        modalBackdrop.style.display = 'none';
        addMonitorForm.reset();
    }

    addMonitorBtn.addEventListener('click', openModal);
    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeModal();
    });

    addMonitorForm.addEventListener('submit', function (e) {
        e.preventDefault();
        if (!currentUserName) {
            alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.");
            return;
        }

        const name   = document.getElementById('monitorName').value.trim();
        const phone  = document.getElementById('monitorPhone').value.trim();
        const center = document.getElementById('monitorCenter').value.trim();
        const code   = document.getElementById('monitorCode').value.trim();
        if (!name || !phone || !center || !code) return;

        const docData = {
            adminUsername: currentUserName,
            monitorName:   name,
            monitorPhone:  phone,
            monitorCenter: center,
            code:          code,
            arrived:   false,
            voted:     false,
            hasIssue:  false,
            issueText: '',
            online:    false,
            location:  null,
            photos:    []
        };

        db.collection('monitors').add(docData)
          .then((docRef) => {
              monitors.push({
                  id: docRef.id,
                  name,
                  phone,
                  center,
                  code,
                  arrived: false,
                  voted: false,
                  hasIssue: false,
                  issueText: '',
                  online: false,
                  location: null,
                  photos: []
              });

              saveMonitors();
              renderMonitors(document.getElementById('searchInput').value);
              closeModal();
              alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙÙŠ Firestore:", err);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          });
    });

    // Ø­Ø¯Ø« Ø²Ø± Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
    deleteAllMonitorsBtn.addEventListener('click', async () => {
        if (!currentUserName) {
            alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.");
            return;
        }
        if (!monitors.length) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§.");
            return;
        }
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

        try {
            const snap = await db.collection('monitors')
                .where('adminUsername', '==', currentUserName)
                .get();

            const batch = db.batch();
            snap.forEach(docu => batch.delete(docu.ref));
            await batch.commit();
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù…Ù† Firestore:", e);
        }

        monitors = [];
        saveMonitors();
        renderMonitors(document.getElementById('searchInput').value);
        alert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    });

    monitorsBody.addEventListener('click', function (e) {
        const action = e.target.dataset.action;
        if (!action) return;
        const index = parseInt(e.target.dataset.index, 10);
        const m = monitors[index];
        if (!m) return;

        if (action === 'toggleArrived') {
            m.arrived = !m.arrived;
            if (m.id) {
                db.collection('monitors').doc(m.id).update({ arrived: m.arrived }).catch(err => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« arrived:", err);
                });
            }

        } else if (action === 'toggleVoted') {
            m.voted = !m.voted;
            if (m.id) {
                db.collection('monitors').doc(m.id).update({ voted: m.voted }).catch(err => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« voted:", err);
                });
            }

        } else if (action === 'viewIssue') {
            if (m.hasIssue) {
                alert(
                    "Ù…Ø´ÙƒÙ„Ø© Ù…Ø¨Ù„Ù‘ÙØºØ© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨:\n\n" +
                    (m.issueText && m.issueText.trim() !== "" ? m.issueText : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©.")
                );
            } else {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¨Ù„Ù‘ÙØºØ© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.");
            }

        } else if (action === 'toggleOnline') {
            // Ù†ØºÙŠÙ‘Ø±Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø­Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø©
            m.online = !m.online;
            if (m.id) {
                db.collection('monitors').doc(m.id).update({ online: m.online }).catch(err => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« online:", err);
                });
            }

        } else if (action === 'deleteMonitor') {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ØŸ')) {
                if (m.id) {
                    db.collection('monitors').doc(m.id).delete().catch(err => {
                        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ù…Ù† Firestore:", err);
                    });
                }
                monitors.splice(index, 1);
            }

        } else if (action === 'viewPhotos') {
            let photos = [];
            if (Array.isArray(m.photos) && m.photos.length) {
                photos = m.photos;
            } else {
                // Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ Ù„Ùˆ ÙƒØ§Ù†Øª ØµÙˆØ± Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø­Ù„ÙŠ
                photos = getMonitorPhotosFromLocal(m.code);
            }

            if (!photos.length) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.");
                return;
            }

            const win = window.open("", "_blank");
            if (!win) {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©. ÙØ¹Ù‘Ù„ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Popup) Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return;
            }

            win.document.write(
                "<html dir='rtl'><head><meta charset='utf-8'><title>ØµÙˆØ± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ " + (m.name || '') + "</title></head>" +
                "<body style='font-family:Tahoma,Arial,sans-serif; background:#f4f6fb; padding:10px;'>" +
                "<h3 style='margin-bottom:10px;'>ØµÙˆØ± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨: " + (m.name || '-') + " â€“ ÙƒÙˆØ¯: " + (m.code || '-') + "</h3>"
            );

            photos.slice(0, 20).forEach(function(src, idx) {
                win.document.write(
                    "<div style='margin:10px 0; padding:8px; background:#ffffff; border-radius:8px; " +
                    "box-shadow:0 2px 6px rgba(0,0,0,0.12);'>" +
                        "<div style='font-size:12px; margin-bottom:4px;'>ØµÙˆØ±Ø© Ø±Ù‚Ù… " + (idx + 1) + "</div>" +
                        "<img src='" + src + "' style='max-width:100%; border-radius:6px; display:block; margin-bottom:4px;'>" +
                        "<a href='" + src + "' download='strip_" + (m.code || 'monitor') + "_" + (idx + 1) + ".png' " +
                        "style='font-size:12px; color:#1a73e8; text-decoration:none;'>ØªÙ†Ø²ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©</a>" +
                    "</div>"
                );
            });

            win.document.write("</body></html>");
            win.document.close();

        } else if (action === "showLocation") {
            let coords = null;

            const locKey = "monitor_location_" + m.code;
            const stored = localStorage.getItem(locKey);

            if (stored) {
                try { 
                    coords = JSON.parse(stored); 
                }
                catch { 
                    coords = null; 
                }
            }

            if (!coords) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹ Ù…ÙØ³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.");
                return;
            }

            const lat = Number(coords.lat);
            const lng = Number(coords.lng);

            if (isNaN(lat) || isNaN(lng)) {
                alert("Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.");
                return;
            }

            const mapIframe = document.getElementById("mainMap");
            if (mapIframe) {
                mapIframe.src =
                    `https://www.google.com/maps?q=${lat.toFixed(6)},${lng.toFixed(6)}&z=19&output=embed`;
            }

            tabs.forEach(t => t.classList.remove("active"));
            const mapTab = document.querySelector('.tab[data-target="mapSection"]');
            if (mapTab) mapTab.classList.add("active");

            document.getElementById('monitorsSection').style.display = 'none';
            document.getElementById('mapSection').style.display      = 'block';
            document.getElementById('reportsSection').style.display  = 'none';
            document.getElementById('searchBox').style.display       = 'none';
        }

        saveMonitors();
        renderMonitors(document.getElementById('searchInput').value);
    });

    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù…Ù† Firestore ÙÙ‚Ø· (ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ) Ø­ØªÙ‰ ØªØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†
    function updateOnlineStatusAuto() {
        if (!currentUserName) return;

        db.collection('monitors')
          .where('adminUsername', '==', currentUserName)
          .get()
          .then((snapshot) => {
              const loaded = [];
              snapshot.forEach((docu) => {
                  const data = docu.data();
                  loaded.push({
                      id:       docu.id,
                      name:     data.monitorName  || '',
                      phone:    data.monitorPhone || '',
                      center:   data.monitorCenter|| '',
                      code:     data.code || data.monitorCode || '',
                      arrived:  !!data.arrived,
                      voted:    !!data.voted,
                      hasIssue: !!data.hasIssue,
                      issueText: data.issueText || '',
                      online:   !!data.online,
                      location: data.location || null,
                      photos:   Array.isArray(data.photos) ? data.photos : []
                  });
              });
              monitors = loaded;
              saveMonitors();
              renderMonitors(document.getElementById('searchInput').value);
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù…Ù† Firestore:", err);
          });
    }

    setInterval(updateOnlineStatusAuto, 3000);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¯ÙˆØ±ÙŠÙ‹Ø§ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…ÙØ¹Ù„ ÙÙŠ Firestore
    function checkUserStillActive() {
        if (!currentUserName) return;

        db.collection('systemUsers')
          .where('username', '==', currentUserName)
          .limit(1)
          .get()
          .then((snapshot) => {
              if (snapshot.empty) {
                  alert("ØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø£Ùˆ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†.");
                  localStorage.removeItem('currentUserName');
                  currentUserName = null;
                  STORAGE_KEY = null;
                  monitors = [];
                  showLogin();
                  return;
              }

              const data = snapshot.docs[0].data();
              if (data.active === false) {
                  alert("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†.");
                  localStorage.removeItem('currentUserName');
                  currentUserName = null;
                  STORAGE_KEY = null;
                  monitors = [];
                  showLogin();
              }
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
          });
    }

    // âš  Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    // setInterval(checkUserStillActive, 4000);

    // ÙØ­Øµ Ù…Ø¨Ø¯Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    (function initialCheck() {
        const savedUser = localStorage.getItem('currentUserName');
        if (!savedUser) {
            showLogin();
            return;
        }

        db.collection('systemUsers')
          .where('username', '==', savedUser)
          .limit(1)
          .get()
          .then((snapshot) => {
              if (snapshot.empty) {
                  localStorage.removeItem('currentUserName');
                  showLogin();
                  return;
              }

              const data = snapshot.docs[0].data();
              if (data.active === false) {
                  localStorage.removeItem('currentUserName');
                  showLogin();
                  return;
              }

              initForUser(savedUser);
              showDashboard();
          })
          .catch((err) => {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„:", err);
              showLogin();
          });
    })();
</script>

</body>
</html>
