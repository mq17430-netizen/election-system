loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("monitorName").value.trim();
    const code = document.getElementById("monitorCode").value.trim().toUpperCase();

    const m = await findMonitorByCodeOnline(code);
    if (!m) {
        loginError.style.display = "block";
        return;
    }

    loginError.style.display = "none";
    currentCode      = code;
    currentMonitorId = m.id;

    photosArray = Array.isArray(m.photos) ? m.photos.slice(0, MAX_PHOTOS) : [];

    statusData = {
        arrived:   !!m.arrived,
        voted:     !!m.voted,
        hasIssue:  !!m.hasIssue,
        issueText: m.issueText || "",
        location:  m.location  || null,
        photoSent: photosArray.length > 0
    };

    welcomeName.textContent = name || m.monitorName || "مراقب";
    welcomeCode.textContent = currentCode;

    loginSection.style.display   = "none";
    monitorSection.style.display = "block";

    // علّم أنه أونلاين
    localStorage.setItem("online_status_" + currentCode, "online");

    // حفظ أن المراقب مسجّل دخول
    localStorage.setItem(LOGIN_FLAG_KEY, "true");
    localStorage.setItem(LOGIN_CODE_KEY, currentCode);
    localStorage.setItem(LOGIN_NAME_KEY, welcomeName.textContent);

    // تحديث حالة المراقب في Firestore ليظهر متصل بلوحة المستخدم
    pushStatusToFirestore({ online: true });

    updateUI();
});
