<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ - Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù†Ø¸Ø§Ù…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Cairo',sans-serif;background:#f4f6fb;}
        .page{max-width:1200px;margin:0 auto;padding:20px;}
        .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .admin-info{display:flex;align-items:center;gap:10px;}
        .admin-icon{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#00c853,#1a9bff);color:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;}
        .card{background:#fff;border-radius:16px;box-shadow:0 8px 18px rgba(15,34,58,0.08);padding:20px;margin-bottom:20px;}
        label{font-size:12px;color:#555;margin-bottom:3px;display:block;}
        input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #dde2ef;font-size:13px;outline:none;}
        input:focus{border-color:#1a9bff;box-shadow:0 0 0 3px rgba(26,155,255,0.12);}
        .btn-primary{padding:10px 20px;border:none;border-radius:12px;background:linear-gradient(90deg,#00c853,#1a9bff,#0066ff);color:white;font-weight:600;font-size:14px;cursor:pointer;box-shadow:0 6px 14px rgba(0,102,255,0.25);}
        table{width:100%;border-collapse:collapse;margin-top:10px;}
        th,td{padding:8px;border-bottom:1px solid #eee;text-align:center;}
        th{color:#777;}
        .badge{padding:4px 8px;border-radius:999px;background:#f1f3fa;font-size:12px;}
        .action-icon{cursor:pointer;font-size:16px;}

        /* ğŸ”µ Ø²Ø± iPhone (ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) */
        .ios-switch {
            position: relative;
            width: 46px;
            height: 26px;
            margin: 0 auto;
        }
        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .ios-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background:#ccc;
            border-radius:34px;
            transition:.25s;
        }
        .ios-slider:before {
            content:"";
            position:absolute;
            height:22px;
            width:22px;
            left:2px;
            top:2px;
            background:#fff;
            border-radius:50%;
            box-shadow:0 1px 3px rgba(0,0,0,0.3);
            transition:.25s;
        }
        .ios-switch input:checked + .ios-slider {
            background:#4cd964; /* Ø£Ø®Ø¶Ø± Ù…Ø«Ù„ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
        }
        .ios-switch input:checked + .ios-slider:before {
            transform:translateX(20px);
        }
    </style>
</head>
<body>

<div class="page">

    <div class="top-bar">
        <div class="admin-info">
            <div class="admin-icon">ğŸ› ï¸</div>
            <div>
                <div style="font-weight:700;">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</div>
                <div style="font-size:12px;color:#777;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØ§Ø± Ù‚Ø§Ø³Ù…</div>
            </div>
        </div>
        <!-- Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (index.html) -->
        <a href="index.html">â¬… Ø±Ø¬ÙˆØ¹ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</a>
    </div>

    <!-- ÙƒØ§Ø±Øª Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
    <div class="card">
        <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
        <div style="margin-top:10px;">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input id="username">

            <label style="margin-top:10px;">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <input id="note">

            <label style="margin-top:10px;">Ø§Ù„ÙƒÙˆØ¯ (ÙŠØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
            <input id="password" readonly>

            <button class="btn-primary" style="margin-top:15px;" id="addUser">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
    </div>

    <!-- ÙƒØ§Ø±Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div class="card">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> <!-- ğŸ”µ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="usersTable"></tbody>
        </table>
    </div>

</div>

<script type="module">
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase (Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        deleteDoc,
        doc,
        updateDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
        authDomain: "election-system-9cbb8.firebaseapp.com",
        projectId: "election-system-9cbb8",
        storageBucket: "election-system-9cbb8.firebasestorage.app",
        messagingSenderId: "886706894008",
        appId: "1:886706894008:web:270556771843614e56b04d"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const col  = collection(db, "systemUsers");

    const SYSTEM_USERS_KEY = "systemUsers";

    const usernameInput = document.getElementById("username");
    const noteInput     = document.getElementById("note");
    const passwordInput = document.getElementById("password");
    const usersTable    = document.getElementById("usersTable");
    const addUserBtn    = document.getElementById("addUser");

    // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ localStorage Ø£ÙŠØ¶Ø§Ù‹)
    let systemUsers = [];

    function generateCode(){
        const L = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        const D = "0123456789";
        let c = "";
        for (let i = 0; i < 3; i++) c += L[Math.floor(Math.random() * L.length)];
        for (let i = 0; i < 2; i++) c += D[Math.floor(Math.random() * D.length)];
        return c;
    }

    function saveSystemUsersToLocal(){
        localStorage.setItem(SYSTEM_USERS_KEY, JSON.stringify(systemUsers));
    }

    function renderUsersTable(){
        usersTable.innerHTML = "";
        let i = 1;
        systemUsers.forEach(u => {
            usersTable.innerHTML += `
                <tr>
                    <td>${i++}</td>
                    <td>${u.username}</td>
                    <td><span class="badge">${u.password}</span></td>
                    <td>${u.note || ""}</td>
                    <td>
                        <label class="ios-switch">
                            <input type="checkbox"
                                   class="userToggle"
                                   data-id="${u.id}"
                                   ${u.active ? "checked" : ""}>
                            <span class="ios-slider"></span>
                        </label>
                    </td>
                    <td>
                        <span class="action-icon"
                              onclick="deleteUser('${u.id}')"
                              title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">ğŸ—‘ï¸</span>
                    </td>
                </tr>
            `;
        });
    }

    async function loadUsers(){
        systemUsers = [];
        const snap = await getDocs(col);
        snap.forEach(docu => {
            const data = docu.data();
            systemUsers.push({
                id:       docu.id,
                username: data.username,
                password: data.password,
                note:     data.note || "",
                active:   (typeof data.active === "boolean") ? data.active : true
            });
        });
        // ØªØ®Ø²ÙŠÙ† Ù†Ø³Ø®Ø© Ø¨Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ index.html ÙŠÙ‚Ø¯Ø± ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        saveSystemUsersToLocal();
        renderUsersTable();
        // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø­Ù‚Ù„
        passwordInput.value = generateCode();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadUsers();

    addUserBtn.onclick = async () => {
        const username = usernameInput.value.trim();
        const note     = noteInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username){
            alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            return;
        }

        try {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Firestore
            const docRef = await addDoc(col, {
                username,
                password,
                note,
                active: true   // ğŸ”µ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙØ¹Ù„
            });

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ†
            systemUsers.push({ id: docRef.id, username, password, note, active: true });
            saveSystemUsersToLocal();
            renderUsersTable();

            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ + ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
            usernameInput.value = "";
            noteInput.value     = "";
            passwordInput.value = generateCode();

            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ ÙÙŠ ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ­ÙƒÙ….");
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    };

    // Ù†Ø¹Ø±Ù‘Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù„Ù‰ window Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ onclick ÙÙŠ Ø§Ù„Ù€ HTML
    window.deleteUser = async (id) => {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

        try {
            await deleteDoc(doc(db, "systemUsers", id));
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
            systemUsers = systemUsers.filter(u => u.id !== id);
            saveSystemUsersToLocal();
            renderUsersTable();
        } catch (e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    };

    // ğŸ”µ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù…Ù† Ø²Ø± Ø§Ù„Ø¢ÙŠÙÙˆÙ†
    document.addEventListener("change", async (e) => {
        if (!e.target.classList.contains("userToggle")) return;

        const id       = e.target.dataset.id;
        const isActive = e.target.checked;

        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const idx = systemUsers.findIndex(u => u.id === id);
        if (idx !== -1) {
            systemUsers[idx].active = isActive;
        }
        saveSystemUsersToLocal();

        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firestore
        try {
            await updateDoc(doc(db, "systemUsers", id), { active: isActive });
        } catch (err) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
            alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    });

    // Ø£ÙˆÙ„ ØªÙˆÙ„ÙŠØ¯ Ù„Ù„ÙƒÙˆØ¯ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    passwordInput.value = generateCode();
</script>

</body>
</html>
