<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a9bff;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --secondary: #9b59b6;
            --dark: #2c3e50;
            --light: #f8f9fa;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
        }
        
        .card {
            background: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        h2 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        h3 {
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        input {
            width: 100%;
            padding: 14px;
            margin: 15px 0;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            font-size: 16px;
            transition: all 0.3s;
            text-align: center;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 155, 255, 0.2);
        }
        
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
            color: white;
            font-size: 16px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-secondary { background: var(--secondary); }
        .btn-info { background: var(--info); }
        
        .status-box {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            text-align: right;
            font-size: 14px;
            border-right: 5px solid var(--primary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .notification-success { background: var(--success); }
        .notification-error { background: var(--danger); }
        .notification-warning { background: var(--warning); }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
        
        .logout-btn {
            background: none;
            color: #777;
            font-size: 13px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .logout-btn:hover {
            background: #f8f9fa;
        }
        
        @media (max-width: 480px) {
            .card { padding: 20px; }
            button { padding: 14px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="loader"></div>
    <p style="margin-top:15px; color: #333;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
</div>

<div id="loginSection" class="card">
    <h2><i class="fas fa-user-check"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</h2>
    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</p>
    
    <input id="uCode" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨">
    <button onclick="login()" class="btn-primary">
        <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
    </button>
    
    <div style="margin-top: 20px; font-size: 12px; color: #888;">
        <i class="fas fa-info-circle"></i> ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    </div>
</div>

<div id="monitorSection" class="card" style="display:none;">
    <h3><i class="fas fa-user-circle"></i> Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="labelName">...</span></h3>
    <p style="font-size:13px; color:#777; margin-bottom:20px;">
        <i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨: <span id="labelCode"></span>
    </p>
    
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value" id="arrivalStat">âŒ</div>
            <div class="stat-label">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="votingStat">âŒ</div>
            <div class="stat-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª</div>
        </div>
    </div>
    
    <button onclick="handleUpdate('monitorArrival', true, 'Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²')" class="btn-success">
        <i class="fas fa-check-circle"></i> âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠ
    </button>
    
    <button onclick="handleUpdate('monitorVoted', true, 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª')" class="btn-primary">
        <i class="fas fa-vote-yea"></i> ğŸ—³ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙˆÙŠØª
    </button>
    
    <button onclick="openIssueModal()" class="btn-danger">
        <i class="fas fa-exclamation-triangle"></i> âš  Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©/Ù…Ø®Ø§Ù„ÙØ©
    </button>
    
    <button onclick="sendLocation()" class="btn-warning">
        <i class="fas fa-map-marker-alt"></i> ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
    </button>
    
    <button onclick="document.getElementById('photoInp').click()" class="btn-secondary">
        <i class="fas fa-camera"></i> ğŸ“· Ø±ÙØ¹ ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØªÙˆØ«ÙŠÙ‚ÙŠØ©
    </button>
    
    <input type="file" id="photoInp" hidden accept="image/*,video/*" multiple onchange="processMedia(this.files)">
    
    <div id="mediaPreview" style="display:none;">
        <img id="previewImage" class="photo-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
        <div id="mediaCount" style="font-size:12px; color:#666; margin-top:5px;"></div>
    </div>
    
    <div class="status-box">
        <h4 style="margin-bottom:15px; color:var(--dark);">
            <i class="fas fa-chart-bar"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        </h4>
        <div class="status-item">
            <span>Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²:</span>
            <span id="arrivalStatus" style="font-weight:bold; color:var(--danger);">Ù„Ù… ÙŠØªÙ…</span>
        </div>
        <div class="status-item">
            <span>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª:</span>
            <span id="votingStatus" style="font-weight:bold; color:var(--danger);">Ù„Ù… ÙŠØªÙ…</span>
        </div>
        <div class="status-item">
            <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
            <span id="lastUpdate" style="color:#666;">--:--</span>
        </div>
        <div class="status-item">
            <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
            <span id="connectionStatus" style="color:var(--success); font-weight:bold;">
                <i class="fas fa-wifi"></i> Ù…ØªØµÙ„
            </span>
        </div>
    </div>
    
    <button onclick="logout()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </button>
</div>

<!-- Ù…Ø´ÙƒÙ„Ø©/Ù…Ø®Ø§Ù„ÙØ© -->
<div id="issueModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10001; align-items:center; justify-content:center;">
    <div class="card" style="max-width:500px; margin:20px;">
        <h3><i class="fas fa-exclamation-circle"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©/Ù…Ø®Ø§Ù„ÙØ©</h3>
        
        <select id="issueType" style="width:100%; padding:12px; margin:15px 0; border-radius:10px; border:2px solid #e0e0e0; font-size:15px;">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</option>
            <option value="ØªØ£Ø®ÙŠØ±">ØªØ£Ø®ÙŠØ± ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</option>
            <option value="Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©">Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø¢Ù„Ø§Øª</option>
            <option value="Ø§Ø²Ø¯Ø­Ø§Ù…">Ø§Ø²Ø¯Ø­Ø§Ù… Ø´Ø¯ÙŠØ¯</option>
            <option value="ØªØ²ÙˆÙŠØ±">Ù…Ø®Ø§Ù„ÙØ©/ØªØ²ÙˆÙŠØ± Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡</option>
            <option value="Ø£Ù…Ù†ÙŠ">Ù…Ø´ÙƒÙ„Ø© Ø£Ù…Ù†ÙŠØ©</option>
            <option value="Ø£Ø®Ø±Ù‰">Ù…Ø´ÙƒÙ„Ø© Ø£Ø®Ø±Ù‰</option>
        </select>
        
        <textarea id="issueDetails" placeholder="Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." rows="4" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:2px solid #e0e0e0;"></textarea>
        
        <div style="display:flex; gap:10px;">
            <button onclick="submitIssue()" class="btn-danger" style="flex:1;">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº
            </button>
            <button onclick="closeIssueModal()" class="btn-primary" style="flex:1; background:#95a5a6;">
                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-storage-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
        authDomain: "election-system-9cbb8.firebaseapp.com",
        projectId: "election-system-9cbb8",
        storageBucket: "election-system-9cbb8.firebasestorage.app",
        messagingSenderId: "886706894008",
        appId: "1:886706894008:web:270556771843614e56b04d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    let currentUser = null;
    let userRef = null;
    let connectionStatus = true;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    window.addEventListener('online', () => {
        connectionStatus = true;
        updateConnectionStatus();
        showNotification('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
    });

    window.addEventListener('offline', () => {
        connectionStatus = false;
        updateConnectionStatus();
        showNotification('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
    });

    async function login() {
        const code = document.getElementById('uCode').value.trim();
        
        if (!code) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            const snap = await db.collection('monitors').where('code', '==', code).get();
            
            if (snap.empty) {
                showNotification('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'error');
                showLoading(false);
                return;
            }
            
            const doc = snap.docs[0];
            currentUser = { 
                docId: doc.id, 
                ...doc.data(),
                lastLogin: new Date().toISOString(),
                ipAddress: await getIPAddress()
            };
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
            await db.collection('monitors').doc(doc.id).update({
                lastLogin: new Date().toISOString(),
                status: 'active',
                isOnline: true,
                lastSeen: new Date().toISOString()
            });
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            setupRealtimeListener(doc.id);
            
            // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('monitorSection').style.display = 'block';
            document.getElementById('labelName').innerText = currentUser.monitorName || currentUser.name || "Ù…Ø±Ø§Ù‚Ø¨";
            document.getElementById('labelCode').innerText = currentUser.code;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„Ø©
            refreshUI();
            
            showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.monitorName || ''}`, 'success');
            
            // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„
            await logActivity('login', { action: 'user_login' });
            
        } catch (error) {
            console.error('Login error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        }
        
        showLoading(false);
    }

    function setupRealtimeListener(docId) {
        userRef = db.collection('monitors').doc(docId);
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
        userRef.onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                currentUser = { ...currentUser, ...data };
                refreshUI();
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(() => {
            if (currentUser) {
                userRef.update({
                    lastSeen: new Date().toISOString(),
                    isOnline: true
                });
            }
        }, 30000);
    }

    async function handleUpdate(field, value, actionLabel) {
        if (!connectionStatus) {
            showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            const timestamp = new Date().toISOString();
            const updateData = {
                [field]: value,
                lastUpdate: timestamp,
                lastAction: actionLabel,
                status: 'active',
                isOnline: true
            };
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„
            if (field === 'monitorArrival') {
                updateData.arrivalTime = timestamp;
                updateData.arrivalConfirmed = true;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ØªØµÙˆÙŠØª
            if (field === 'monitorVoted') {
                updateData.votingCompleteTime = timestamp;
                updateData.votingCompleted = true;
            }
            
            await userRef.update(updateData);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            await logActivity('status_update', {
                field: field,
                value: value,
                action: actionLabel
            });
            
            showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${actionLabel} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            
        } catch (error) {
            console.error('Update error:', error);
            showNotification('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
        }
        
        showLoading(false);
    }

    function openIssueModal() {
        document.getElementById('issueModal').style.display = 'flex';
    }

    function closeIssueModal() {
        document.getElementById('issueModal').style.display = 'none';
        document.getElementById('issueType').value = '';
        document.getElementById('issueDetails').value = '';
    }

    async function submitIssue() {
        const type = document.getElementById('issueType').value;
        const details = document.getElementById('issueDetails').value.trim();
        
        if (!type) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
            return;
        }
        
        if (!details) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            const timestamp = new Date().toISOString();
            const issueId = `issue_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
            const issueData = {
                id: issueId,
                monitorId: currentUser.docId,
                monitorCode: currentUser.code,
                monitorName: currentUser.monitorName || currentUser.name,
                issueType: type,
                issueDetails: details,
                status: 'new',
                priority: type === 'ØªØ²ÙˆÙŠØ±' || type === 'Ø£Ù…Ù†ÙŠ' ? 'high' : 'medium',
                timestamp: timestamp,
                location: currentUser.monitorLocation || null,
                centerId: currentUser.centerId || null,
                centerName: currentUser.centerName || null
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù„Ø§Øº Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.collection('issues').add(issueData);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            await userRef.update({
                hasActiveIssue: true,
                lastIssueReported: timestamp,
                lastIssueType: type,
                lastUpdate: timestamp
            });
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            await logActivity('issue_report', {
                issueId: issueId,
                type: type,
                details: details.substring(0, 100) // Ø­ÙØ¸ Ø£ÙˆÙ„ 100 Ø­Ø±Ù ÙÙ‚Ø·
            });
            
            showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­', 'success');
            closeIssueModal();
            
        } catch (error) {
            console.error('Issue submission error:', error);
            showNotification('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº', 'error');
        }
        
        showLoading(false);
    }

    function sendLocation() {
        if (!navigator.geolocation) {
            showNotification('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
            return;
        }
        
        showLoading(true);
        
        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                try {
                    const location = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    await userRef.update({
                        monitorLocation: location,
                        lastLocationUpdate: new Date().toISOString(),
                        lastUpdate: new Date().toISOString()
                    });
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
                    await logActivity('location_update', {
                        coordinates: location
                    });
                    
                    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                } catch (error) {
                    console.error('Location error:', error);
                    showNotification('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                }
                
                showLoading(false);
            },
            (error) => {
                console.error('Geolocation error:', error);
                showNotification('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                showLoading(false);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    async function processMedia(files) {
        if (!files.length) return;
        
        showLoading(true);
        
        try {
            const mediaUrls = [];
            const timestamp = new Date().toISOString();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ù…Ù„Ù
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `media_${currentUser.code}_${timestamp}_${i}.${fileExt}`;
                const ref = storage.ref(`monitoring_media/${currentUser.code}/${fileName}`);
                
                // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                await ref.put(file);
                const url = await ref.getDownloadURL();
                
                mediaUrls.push({
                    url: url,
                    type: file.type.startsWith('image/') ? 'image' : 'video',
                    name: file.name,
                    size: file.size,
                    timestamp: timestamp
                });
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                if (i === 0 && file.type.startsWith('image/')) {
                    document.getElementById('mediaPreview').style.display = 'block';
                    document.getElementById('previewImage').src = URL.createObjectURL(file);
                    document.getElementById('previewImage').style.display = 'block';
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
            await userRef.update({
                mediaAttachments: firebase.firestore.FieldValue.arrayUnion(...mediaUrls),
                lastMediaUpload: timestamp,
                lastUpdate: timestamp
            });
            
            // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
            document.getElementById('mediaCount').innerHTML = 
                `<i class="fas fa-check-circle"></i> ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`;
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            await logActivity('media_upload', {
                count: files.length,
                types: mediaUrls.map(m => m.type)
            });
            
            showNotification(`ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            
        } catch (error) {
            console.error('Media upload error:', error);
            showNotification('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·', 'error');
        }
        
        showLoading(false);
    }

    function refreshUI() {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„
        const arrivalStatus = currentUser.monitorArrival ? 'âœ… ØªÙ…' : 'âŒ Ù„Ù… ÙŠØªÙ…';
        document.getElementById('arrivalStatus').innerHTML = arrivalStatus;
        document.getElementById('arrivalStatus').style.color = currentUser.monitorArrival ? 'var(--success)' : 'var(--danger)';
        document.getElementById('arrivalStat').innerHTML = currentUser.monitorArrival ? 'âœ…' : 'âŒ';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª
        const votingStatus = currentUser.monitorVoted ? 'âœ… ØªÙ…' : 'âŒ Ù„Ù… ÙŠØªÙ…';
        document.getElementById('votingStatus').innerHTML = votingStatus;
        document.getElementById('votingStatus').style.color = currentUser.monitorVoted ? 'var(--success)' : 'var(--danger)';
        document.getElementById('votingStat').innerHTML = currentUser.monitorVoted ? 'âœ…' : 'âŒ';
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        if (currentUser.lastUpdate) {
            const date = new Date(currentUser.lastUpdate);
            const timeStr = date.toLocaleTimeString('ar-EG', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            document.getElementById('lastUpdate').innerText = timeStr;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        updateConnectionStatus();
    }

    function updateConnectionStatus() {
        const statusEl = document.getElementById('connectionStatus');
        if (connectionStatus) {
            statusEl.innerHTML = '<i class="fas fa-wifi"></i> Ù…ØªØµÙ„';
            statusEl.style.color = 'var(--success)';
        } else {
            statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> ØºÙŠØ± Ù…ØªØµÙ„';
            statusEl.style.color = 'var(--danger)';
        }
    }

    async function getIPAddress() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            return 'unknown';
        }
    }

    async function logActivity(type, details = {}) {
        try {
            await db.collection('activityLogs').add({
                monitorId: currentUser.docId,
                monitorCode: currentUser.code,
                monitorName: currentUser.monitorName || currentUser.name,
                activityType: type,
                details: details,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                ipAddress: await getIPAddress()
            });
        } catch (error) {
            console.error('Failed to log activity:', error);
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 4000);
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function logout() {
        if (currentUser && userRef) {
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
            userRef.update({
                status: 'offline',
                isOnline: false,
                lastSeen: new Date().toISOString()
            });
            
            // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø®Ø±ÙˆØ¬
            logActivity('logout', { action: 'user_logout' });
        }
        
        location.reload();
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    updateConnectionStatus();
</script>
</body>
</html>
