<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary:#1a9bff;
            --accent:#00c853;
            --danger:#e53935;
            --warning:#ff9800;
            --bg:#f5f7fb;
        }

        *{box-sizing:border-box;margin:0;padding:0;}

        body{
            font-family:'Cairo',sans-serif;
            min-height:100vh;
            background:radial-gradient(circle at top left,#e0f2ff 0,#f7fbff 35%,#e6fff4 100%);
            padding:32px 12px;
        }

        .container{
            max-width:1150px;
            margin:0 auto;
        }

        /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆÙ…Ù„Ø®Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ===== */
        .header{
            display:flex;
            flex-wrap:wrap;
            justify-content:space-between;
            align-items:center;
            margin-bottom:18px;
            gap:10px;
        }

        .header-title h1{
            font-size:24px;
            margin-bottom:4px;
        }
        .header-title p{
            font-size:13px;
            color:#777;
        }

        .summary-pill{
            background:linear-gradient(90deg,#00c853,#1a9bff,#0066ff);
            padding:8px 16px;
            border-radius:999px;
            color:#fff;
            font-size:13px;
            display:inline-flex;
            align-items:center;
            gap:8px;
            box-shadow:0 8px 20px rgba(0,102,255,0.22);
        }
        .summary-pill-dot{
            width:11px;
            height:11px;
            border-radius:50%;
            background:#69f0ae;
            box-shadow:0 0 0 4px rgba(105,240,174,0.4);
        }

        /* ===== Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ + Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
        .card{
            background:#fff;
            border-radius:22px;
            box-shadow:0 18px 40px rgba(15,34,58,0.14);
            padding:16px 18px 18px;
            overflow-x:auto;
        }

        .search-box{
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            margin-bottom:10px;
            align-items:center;
        }
        .search-box input{
            flex:1;
            min-width:210px;
            border-radius:999px;
            border:1px solid #dde3ee;
            padding:8px 14px;
            font-size:13px;
            outline:none;
            background:#f8faff;
        }
        .search-box input:focus{
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(26,155,255,0.18);
            background:#ffffff;
        }
        .search-info{
            font-size:11px;
            color:#777;
        }

        table{
            width:100%;
            border-collapse:collapse;
            min-width:900px;
            margin-top:6px;
        }

        th,td{
            padding:9px 6px;
            font-size:12px;
            text-align:center;
            border-bottom:1px solid #eef0f7;
        }

        th{
            background:linear-gradient(90deg,#f3f6ff,#f8fbff);
            font-weight:600;
            color:#455a64;
            position:sticky;
            top:0;
            z-index:1;
        }

        tr:nth-child(even){
            background:#fafbff;
        }

        /* ===== Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª ÙˆØ§Ù„ØªØ§Ù‚Ø§Øª ===== */
        .badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            border-radius:999px;
            padding:4px 10px;
            font-size:11px;
            font-weight:600;
        }
        .badge-online{
            background:rgba(0,200,83,0.08);
            color:#1b5e20;
        }
        .badge-offline{
            background:rgba(244,67,54,0.08);
            color:#b71c1c;
        }

        .badge-online::before,
        .badge-offline::before{
            content:"";
            width:9px;
            height:9px;
            border-radius:50%;
        }
        .badge-online::before{
            background:#00e676;
            box-shadow:0 0 0 3px rgba(0,230,118,0.35);
        }
        .badge-offline::before{
            background:#ff8a80;
            box-shadow:0 0 0 3px rgba(255,138,128,0.35);
        }

        .tag{
            display:inline-block;
            padding:3px 10px;
            border-radius:999px;
            font-size:11px;
            white-space:nowrap;
        }
        .tag-yes{
            background:rgba(76,175,80,0.12);
            color:#1b5e20;
        }
        .tag-no{
            background:rgba(158,158,158,0.15);
            color:#616161;
        }
        .tag-issue{
            background:rgba(255,152,0,0.12);
            color:#e65100;
        }
        .tag-photo{
            background:rgba(123,31,162,0.13);
            color:#4a148c;
        }

        .loc-text{
            font-family:monospace;
            font-size:11px;
        }

        .footer{
            margin-top:14px;
            font-size:11px;
            color:#999;
            text-align:center;
        }

        @media (max-width:600px){
            body{padding:18px 8px;}
            .header{
                align-items:flex-start;
            }
            .header-title h1{
                font-size:20px;
            }
            .card{
                padding:14px 12px 16px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div class="header">
        <div class="header-title">
            <h1>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†</h1>
            <p>Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„Ø­Ø¸ÙŠØ§Ù‹ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† ÙˆÙ…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²</p>
        </div>

        <!-- Ù…Ù„Ø®Øµ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù† -->
        <div class="summary-pill" id="summaryBadge">
            <span class="summary-pill-dot"></span>
            <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: â€”</span>
        </div>
    </div>

    <!-- Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="card">
        <!-- Ø§Ù„Ø¨Ø­Ø« -->
        <div class="search-box">
            <input id="searchInput" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
            <div class="search-info" id="searchInfo">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†: â€”</div>
        </div>

        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ÙˆØµÙˆÙ„</th>
                <th>Ø§Ù„ØªØµÙˆÙŠØª</th>
                <th>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</th>
                <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Lat,Lng)</th>
                <th>Ø§Ù„Ø¯Ù‚Ø© (Ù…)</th>
                <th>ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹</th>
                <th>Ø§Ù„ØµÙˆØ±</th>
            </tr>
            </thead>
            <tbody id="monitorsTableBody">
            <!-- ÙŠÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† Firestore -->
            </tbody>
        </table>
    </div>

    <div class="footer">
        ØªØ·ÙˆÙŠØ±: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØ§Ø± Ù‚Ø§Ø³Ù… â€” ÙŠØ¹Ù…Ù„ Ù…Ù† Ø£ÙŠ Ø­Ø§Ø³Ø¨Ø© Ø£Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ø¨Ø± GitHub + Firestore
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
  authDomain:"election-system-9cbb8.firebaseapp.com",
  projectId:"election-system-9cbb8",
  storageBucket:"election-system-9cbb8.firebasestorage.app",
  messagingSenderId:"886706894008",
  appId:"1:886706894008:web:270556771843614e56b04d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tbody = document.getElementById("monitorsTableBody");
const searchInput = document.getElementById("searchInput");
const searchInfo = document.getElementById("searchInfo");
const summaryBadge = document.getElementById("summaryBadge");

let monitorsCache = [];

// ÙÙˆØ±Ù…Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙˆØ±Ø© Ù…Ù‚Ø±ÙˆØ¡Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
function formatDate(ts){
    if(!ts) return "â€”";
    try{
        const d = new Date(ts);
        if(isNaN(d.getTime())) return "â€”";
        return d.toLocaleString("ar-IQ");
    }catch(e){
        return "â€”";
    }
}

// Ø±Ø³Ù… ØµÙ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function renderRow(data, index){
    const name = data.monitorName || data.name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const code = data.code || "â€”";
    const online = data.online === true;
    const arrived = !!data.arrived;
    const voted = !!data.voted;
    const hasIssue = !!data.hasIssue;
    const issueText = data.issueText || "";
    const photos = Array.isArray(data.photos) ? data.photos : [];
    const photoCount = photos.length;

    const loc = data.location || null;
    let latLngText = "â€”";
    let accuracyText = "â€”";
    let timeText = "â€”";

    if(loc && typeof loc.lat === "number" && typeof loc.lng === "number"){
        latLngText = loc.lat.toFixed(6)+", "+loc.lng.toFixed(6);
        if(typeof loc.accuracy === "number"){
            accuracyText = Math.round(loc.accuracy) + " Ù…";
        }
        if(loc.timestamp){
            timeText = formatDate(loc.timestamp);
        }
    }

    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td>${index+1}</td>
        <td><strong>${code}</strong></td>
        <td>${name}</td>
        <td>
            <span class="badge ${online ? "badge-online" : "badge-offline"}">
                ${online ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„"}
            </span>
        </td>
        <td>
            <span class="tag ${arrived ? "tag-yes" : "tag-no"}">
                ${arrived ? "ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„" : "Ù„Ù… ÙŠØ­Ø¯Ø¯"}
            </span>
        </td>
        <td>
            <span class="tag ${voted ? "tag-yes" : "tag-no"}">
                ${voted ? "ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª" : "Ù„Ù… ÙŠØ­Ø¯Ø¯"}
            </span>
        </td>
        <td>
            ${
                hasIssue
                ? `<span class="tag tag-issue" title="${issueText.replace(/"/g,"&quot;")}">Ù…Ø´ÙƒÙ„Ø©</span>`
                : `<span class="tag tag-no">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`
            }
        </td>
        <td class="loc-text">${latLngText}</td>
        <td>${accuracyText}</td>
        <td>${timeText}</td>
        <td>
            ${
                photoCount > 0
                ? `<span class="tag tag-photo">ğŸ“· ${photoCount} ØµÙˆØ±Ø©</span>`
                : `<span class="tag tag-no">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`
            }
        </td>
    `;

    return tr;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„ÙƒØ§Ø´ + Ø§Ù„ÙÙ„ØªØ±
function refreshTable(){
    const q = (searchInput.value || "").trim().toLowerCase();
    tbody.innerHTML = "";

    const filtered = monitorsCache.filter(m=>{
        const name = (m.monitorName || m.name || "").toLowerCase();
        const code = (m.code || "").toLowerCase();
        if(!q) return true;
        return name.includes(q) || code.includes(q);
    });

    filtered.forEach((m,idx)=>{
        const row = renderRow(m, idx);
        tbody.appendChild(row);
    });

    searchInfo.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†: ${filtered.length} Ù…Ù† Ø£ØµÙ„ ${monitorsCache.length}`;

    const onlineCount = monitorsCache.filter(m => m.online === true).length;
    const span = summaryBadge.querySelector("span:last-child");
    if(span){
        span.textContent = onlineCount > 0
            ? `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†: ${onlineCount}`
            : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø§Ù‚Ø¨ Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹";
    }
}

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ ØªØºÙŠÙ‘Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
db.collection("monitors")
  .orderBy("code")
  .onSnapshot(snap=>{
      monitorsCache = [];
      snap.forEach(doc=>{
          const d = doc.data();
          d._id = doc.id; // Ù„Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ù„Ø§Ø­Ù‚Ø§Ù‹
          monitorsCache.push(d);
      });
      refreshTable();
  }, err=>{
      console.error("Firestore listen error:", err);
      const span = summaryBadge.querySelector("span:last-child");
      if(span){
          span.textContent = "âš  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      }
  });

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
searchInput.addEventListener("input", ()=>{
    refreshTable();
});
</script>

</body>
</html>
