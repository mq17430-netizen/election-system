<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØµÙØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        *{box-sizing:border-box;margin:0;padding:0;}

        body{
            font-family:'Cairo',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
            min-height:100vh;
            background:radial-gradient(circle at top,#e0f2ff 0,#f7fbff 45%,#e6fff4 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:16px;
        }

        .card{
            background:#fff;
            border-radius:20px;
            box-shadow:0 18px 40px rgba(15,34,58,0.18);
            max-width:420px;
            width:100%;
            padding:20px 18px 16px;
        }

        .icon-circle{
            width:64px;
            height:64px;
            border-radius:50%;
            margin:0 auto 10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:32px;
            color:#fff;
            background:linear-gradient(135deg,#00c853,#1a9bff);
        }

        h1{
            font-size:20px;
            text-align:center;
            margin-bottom:4px;
        }

        .subtitle{
            font-size:13px;
            color:#666;
            text-align:center;
            margin-bottom:14px;
        }

        .section-title{
            font-size:14px;
            font-weight:700;
            margin:14px 0 6px;
        }

        .form-group{
            margin-bottom:10px;
            text-align:right;
        }

        label{
            display:block;
            font-size:12px;
            margin-bottom:3px;
            color:#444;
        }

        input,textarea{
            width:100%;
            border-radius:10px;
            border:1px solid #dde2ef;
            padding:8px 10px;
            font-size:13px;
            outline:none;
        }

        input:focus,textarea:focus{
            border-color:#1a9bff;
            box-shadow:0 0 0 3px rgba(26,155,255,0.12);
        }

        textarea{
            resize:vertical;
            min-height:70px;
            max-height:150px;
        }

        .btn{
            width:100%;
            border:none;
            border-radius:12px;
            padding:9px 0;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            background:linear-gradient(90deg,#00c853,#1a9bff,#0066ff);
            color:#fff;
            box-shadow:0 10px 22px rgba(0,102,255,0.25);
            margin-top:4px;
        }

        .btn-secondary{
            background:#f5f7ff;
            color:#244673;
            box-shadow:none;
            border:1px solid #dde2ef;
        }

        .btn-row{
            display:flex;
            gap:8px;
            margin-top:6px;
        }

        .btn-row .btn-small{
            flex:1;
            padding:7px 0;
            font-size:12px;
            border-radius:10px;
        }

        .status-badge{
            margin-top:8px;
            font-size:12px;
            text-align:center;
            padding:6px 8px;
            border-radius:999px;
            background:rgba(0,200,83,0.06);
            color:#1b5e20;
        }

        .status-badge.offline{
            background:rgba(244,67,54,0.06);
            color:#b71c1c;
        }

        .hint{
            margin-top:10px;
            font-size:11px;
            color:#777;
            text-align:right;
            line-height:1.5;
        }

        .error{
            margin-top:6px;
            font-size:12px;
            color:#c62828;
            display:none;
        }

        .success-msg{
            margin-top:6px;
            font-size:12px;
            color:#2e7d32;
            display:none;
        }

        .small{
            font-size:11px;
            color:#666;
            margin-top:4px;
            text-align:right;
        }

        #monitorSection{display:none;}
    </style>
</head>
<body>

<div class="card" id="loginCard">
    <div class="icon-circle">ğŸ§¾</div>
    <h1>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</h1>
    <p class="subtitle">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù…ØªÙ‡ Ù…Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.</p>

    <form id="loginForm">
        <div class="form-group">
            <label for="monitorCodeInput">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</label>
            <input type="text" id="monitorCodeInput" placeholder="Ù…Ø«Ø§Ù„: ABXC3">
        </div>
        <button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
        <div id="loginError" class="error"></div>
    </form>

    <p class="hint">
        * Ø§Ù„ÙƒÙˆØ¯ ÙŠÙØ¹Ø·ÙŠÙƒ Ø¥ÙŠØ§Ù‡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ù„ÙˆØ­Ø©.<br>
        * Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ ØºÙŠØ± Ù…Ø®ÙˆÙ‘Ù„.
    </p>
</div>

<div class="card" id="monitorSection">
    <div class="icon-circle">ğŸ“¡</div>
    <h1 id="monitorNameTitle">Ù…Ø±Ø­Ø¨Ø§ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</h1>
    <p class="subtitle" id="monitorCenterSubtitle">Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹: â€”</p>

    <div id="onlineBadge" class="status-badge">ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù†</div>

    <div class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</div>
    <div class="btn-row">
        <button type="button" id="btnArrived" class="btn btn-small btn-secondary">âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„</button>
        <button type="button" id="btnVoted"  class="btn btn-small btn-secondary">ğŸ—³ï¸ ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª</button>
    </div>

    <div class="section-title">Ø¥Ø±Ø³Ø§Ù„ Ù…Ø´ÙƒÙ„Ø©</div>
    <div class="form-group">
        <label for="issueText">Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª</label>
        <textarea id="issueText" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù…Ø§ ÙŠØ­Ø¯Ø« ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²ØŒ ØªØ£Ø®ÙŠØ±ØŒ Ø¥ØºÙ„Ø§Ù‚ØŒ Ù†Ù‚Øµ Ø£ÙˆØ±Ø§Ù‚ØŒ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©..."></textarea>
    </div>
    <div class="btn-row">
        <button type="button" id="btnSendIssue" class="btn btn-small">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</button>
        <button type="button" id="btnClearIssue" class="btn btn-small btn-secondary">Ù…Ø³Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</button>
    </div>

    <div class="section-title">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</div>
    <button type="button" id="btnSendLocation" class="btn btn-secondary">ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>

    <p class="small" id="lastLocationInfo">Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹: Ù„Ù… ÙŠÙØ±Ø³Ù„ Ø¨Ø¹Ø¯.</p>

    <div id="actionSuccess" class="success-msg"></div>
    <div id="actionError" class="error"></div>

    <button type="button" id="btnLogout" class="btn btn-secondary" style="margin-top:10px;">
        â¬… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    </button>

    <p class="hint">
        * Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ ÙƒÙ€ "ØºÙŠØ± Ù…ØªØµÙ„" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†.<br>
        * ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ".
    </p>
</div>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
        authDomain: "election-system-9cbb8.firebaseapp.com",
        projectId: "election-system-9cbb8",
        storageBucket: "election-system-9cbb8.firebasestorage.app",
        messagingSenderId: "886706894008",
        appId: "1:886706894008:web:270556771843614e56b04d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const loginCard           = document.getElementById('loginCard');
    const monitorSection      = document.getElementById('monitorSection');
    const loginForm           = document.getElementById('loginForm');
    const loginError          = document.getElementById('loginError');
    const monitorCodeInput    = document.getElementById('monitorCodeInput');

    const monitorNameTitle    = document.getElementById('monitorNameTitle');
    const monitorCenterSubtitle = document.getElementById('monitorCenterSubtitle');
    const onlineBadge         = document.getElementById('onlineBadge');
    const issueTextInput      = document.getElementById('issueText');
    const lastLocationInfo    = document.getElementById('lastLocationInfo');

    const btnArrived          = document.getElementById('btnArrived');
    const btnVoted            = document.getElementById('btnVoted');
    const btnSendIssue        = document.getElementById('btnSendIssue');
    const btnClearIssue       = document.getElementById('btnClearIssue');
    const btnSendLocation     = document.getElementById('btnSendLocation');
    const btnLogout           = document.getElementById('btnLogout');

    const actionSuccess       = document.getElementById('actionSuccess');
    const actionError         = document.getElementById('actionError');

    let currentMonitorId   = null;
    let currentMonitorData = null;

    function showError(el, msg){
        el.textContent = msg;
        el.style.display = 'block';
    }
    function hideError(el){
        el.textContent = '';
        el.style.display = 'none';
    }
    function showSuccess(msg){
        actionSuccess.textContent = msg;
        actionSuccess.style.display = 'block';
        setTimeout(()=>{ actionSuccess.style.display = 'none'; }, 3000);
    }

    function setOnlineBadge(isOnline){
        if(isOnline){
            onlineBadge.classList.remove('offline');
            onlineBadge.textContent = 'ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù†';
        }else{
            onlineBadge.classList.add('offline');
            onlineBadge.textContent = 'âšª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…';
        }
    }

    function formatLocationInfo(location){
        if(!location || typeof location.lat !== 'number' || typeof location.lng !== 'number'){
            return 'Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹: Ù„Ù… ÙŠÙØ±Ø³Ù„ Ø¨Ø¹Ø¯.';
        }
        const lat = location.lat.toFixed(6);
        const lng = location.lng.toFixed(6);
        const acc = typeof location.accuracy === 'number' ? Math.round(location.accuracy) + ' Ù…' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
        const ts  = location.timestamp ? new Date(location.timestamp).toLocaleString('ar-IQ') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        return `Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹: (${lat}, ${lng}) - Ø¯Ù‚Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ${acc} - ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${ts}`;
    }

    function updateMonitor(fields){
        if(!currentMonitorId) return Promise.reject(new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø§Ù‚Ø¨ Ù…Ø³Ø¬Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.'));
        return db.collection('monitors').doc(currentMonitorId).update(fields);
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
    loginForm.addEventListener('submit', function(e){
        e.preventDefault();
        hideError(loginError);

        const code = (monitorCodeInput.value || '').trim().toUpperCase();
        if(!code){
            showError(loginError, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨.');
            return;
        }

        db.collection('monitors')
          .where('code', '==', code)
          .limit(1)
          .get()
          .then((snapshot)=>{
              if(snapshot.empty){
                  showError(loginError, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø±Ø§Ø¬Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.');
                  return;
              }

              const doc = snapshot.docs[0];
              currentMonitorId   = doc.id;
              currentMonitorData = doc.data();

              // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
              const name   = currentMonitorData.monitorName  || currentMonitorData.name || 'Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨';
              const center = currentMonitorData.monitorCenter|| 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

              monitorNameTitle.textContent      = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + name;
              monitorCenterSubtitle.textContent = 'Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¹: ' + center;
              lastLocationInfo.textContent      = formatLocationInfo(currentMonitorData.location);

              // Ø§Ø¹ØªØ¨Ø±Ù‡ Ù…ØªØµÙ„
              updateMonitor({ online:true })
                .then(()=>{
                    setOnlineBadge(true);
                })
                .catch((err)=>{
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', err);
                });

              // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙˆØ¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
              loginCard.style.display    = 'none';
              monitorSection.style.display = 'block';
          })
          .catch((err)=>{
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨:', err);
              showError(loginError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
          });
    });

    // Ø²Ø± "ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„"
    btnArrived.addEventListener('click', function(){
        updateMonitor({ arrived:true })
          .then(()=>{ showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.'); })
          .catch((err)=>{
              console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØµÙˆÙ„:', err);
              showError(actionError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„.');
          });
    });

    // Ø²Ø± "ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª"
    btnVoted.addEventListener('click', function(){
        updateMonitor({ voted:true })
          .then(()=>{ showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ù†Ø¬Ø§Ø­.'); })
          .catch((err)=>{
              console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙˆÙŠØª:', err);
              showError(actionError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª.');
          });
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø´ÙƒÙ„Ø©
    btnSendIssue.addEventListener('click', function(){
        hideError(actionError);
        const txt = (issueTextInput.value || '').trim();
        if(!txt){
            showError(actionError, 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
            return;
        }

        updateMonitor({ hasIssue:true, issueText:txt })
          .then(()=>{
              showSuccess('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.');
          })
          .catch((err)=>{
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:', err);
              showError(actionError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.');
          });
    });

    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    btnClearIssue.addEventListener('click', function(){
        hideError(actionError);
        issueTextInput.value = '';
        updateMonitor({ hasIssue:false, issueText:'' })
          .then(()=>{
              showSuccess('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.');
          })
          .catch((err)=>{
              console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:', err);
              showError(actionError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.');
          });
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
    btnSendLocation.addEventListener('click', function(){
        hideError(actionError);
        if(!navigator.geolocation){
            showError(actionError, 'Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.');
            return;
        }

        btnSendLocation.disabled = true;
        btnSendLocation.textContent = 'ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';

        navigator.geolocation.getCurrentPosition(
            (pos)=>{
                const coords = pos.coords;
                const loc = {
                    lat: coords.latitude,
                    lng: coords.longitude,
                    accuracy: coords.accuracy,
                    timestamp: Date.now()
                };

                updateMonitor({ location:loc })
                  .then(()=>{
                      lastLocationInfo.textContent = formatLocationInfo(loc);
                      showSuccess('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­.');
                  })
                  .catch((err)=>{
                      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', err);
                      showError(actionError, 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
                  })
                  .finally(()=>{
                      btnSendLocation.disabled = false;
                      btnSendLocation.textContent = 'ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
                  });
            },
            (err)=>{
                console.error('geolocation error:', err);
                let msg = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.';
                if(err.code === 1) msg = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.';
                showError(actionError, msg);
                btnSendLocation.disabled = false;
                btnSendLocation.textContent = 'ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            },
            {
                enableHighAccuracy:true,
                timeout:15000,
                maximumAge:0
            }
        );
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    btnLogout.addEventListener('click', function(){
        if(currentMonitorId){
            updateMonitor({ online:false })
              .catch((err)=>{ console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (ØªØ­Ø¯ÙŠØ« online):', err); })
              .finally(()=>{
                  currentMonitorId   = null;
                  currentMonitorData = null;
                  monitorSection.style.display = 'none';
                  loginCard.style.display      = 'block';
                  monitorCodeInput.value       = '';
                  issueTextInput.value         = '';
                  setOnlineBadge(false);
              });
        }else{
            monitorSection.style.display = 'none';
            loginCard.style.display      = 'block';
            setOnlineBadge(false);
        }
    });

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ offline Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', function(){
        if(currentMonitorId){
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±ÙŠØ¹Ø©ØŒ Ù‚Ø¯ Ù„Ø§ ØªÙ†Ø¬Ø­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ÙƒÙ†Ù‡Ø§ Ù…ÙÙŠØ¯Ø© ÙÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            db.collection('monitors').doc(currentMonitorId).update({ online:false }).catch(()=>{});
        }
    });
</script>

</body>
</html>
