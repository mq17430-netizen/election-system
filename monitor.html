<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a9bff; --accent: #00c853; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        
        body { 
            background: #f4f7f6; 
            display: flex; align-items: center; justify-content: center; 
            min-height: 100vh; padding: 15px;
        }

        .card { 
            background: #ffffff; padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
            width: 100%; max-width: 400px; text-align: center;
        }

        h2 { font-size: 20px; margin-bottom: 20px; color: #333; }
        .input-group { text-align: right; margin-bottom: 15px; }
        label { font-size: 13px; color: #666; display: block; margin-bottom: 5px; }
        
        input { 
            width: 100%; padding: 12px; border: 1px solid #e0e0e0; 
            border-radius: 12px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 155, 255, 0.1); }

        button { 
            width: 100%; padding: 13px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-main { background: var(--primary); color: #fff; margin-top: 10px; }
        .btn-main:active { transform: scale(0.98); }

        .action-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        .btn-green { background: #2ecc71; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-orange { background: #f39c12; color: white; }
        .btn-purple { background: #9b59b6; color: white; }

        .status-box { 
            background: #f9f9f9; padding: 15px; border-radius: 15px; 
            margin-top: 20px; text-align: right; font-size: 14px;
            border-right: 4px solid var(--primary);
        }

        #loadingOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 9999; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); 
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .preview-imgs { display: flex; gap: 8px; overflow-x: auto; margin-top: 10px; padding-bottom: 5px; }
        .preview-imgs img { width: 55px; height: 55px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="loader"></div>
    <p id="loadText" style="margin-top:15px; font-weight:bold; color:#555;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
</div>

<div id="loginSection" class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</h2>
    <form id="loginForm">
        <div class="input-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="uName" type="text" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ±">
        </div>
        <div class="input-group">
            <label>ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ</label>
            <input id="uCode" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ" required>
        </div>
        <button type="submit" class="btn-main">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <p id="loginMsg" style="color:red; font-size:12px; margin-top:10px; display:none;">Ø®Ø·Ø£: Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!</p>
    </form>
</div>

<div id="monitorSection" class="card" style="display:none;">
    <h3 style="margin-bottom:5px;">Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="labelName">...</span></h3>
    <p style="font-size:12px; color:gray; margin-bottom:20px;">ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="labelCode"></span></p>

    <div class="action-grid">
        <button onclick="handleUpdate('arrived', true, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„')" class="btn-green">âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²</button>
        <button onclick="handleUpdate('voted', true, 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª')" class="btn-blue">ğŸ—³ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙˆÙŠØª</button>
        <button onclick="reportIssue()" class="btn-red">âš  Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</button>
        <button id="locBtn" onclick="sendLocation()" class="btn-orange">ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</button>
        <button onclick="document.getElementById('photoInp').click()" class="btn-purple">ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±</button>
    </div>

    <input type="file" id="photoInp" multiple hidden onchange="processPhotos(this.files)">

    <div class="status-box" id="summaryUI">
        Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
    </div>

    <div id="imgContainer" class="preview-imgs"></div>

    <button onclick="logout()" style="background:none; color:#999; font-size:12px; margin-top:20px; text-decoration:underline;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-storage-compat.js"></script>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
        authDomain: "election-system-9cbb8.firebaseapp.com",
        projectId: "election-system-9cbb8",
        storageBucket: "election-system-9cbb8.firebasestorage.app",
        messagingSenderId: "886706894008",
        appId: "1:886706894008:web:270556771843614e56b04d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUser = null;

    const overlay = document.getElementById('loadingOverlay');
    const loadText = document.getElementById('loadText');

    function toggleLoader(show, text = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...") {
        loadText.innerText = text;
        overlay.style.display = show ? 'flex' : 'none';
    }

    // Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        const code = document.getElementById('uCode').value;
        const name = document.getElementById('uName').value;
        
        toggleLoader(true, "ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯...");
        
        try {
            const snap = await db.collection('monitors').where('code', '==', code).get();
            
            if (snap.empty) {
                document.getElementById('loginMsg').style.display = 'block';
                toggleLoader(false);
            } else {
                const doc = snap.docs[0];
                currentUser = { docId: doc.id, ...doc.data() };
                if (name) currentUser.monitorName = name; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
                
                localStorage.setItem('monitor_user', JSON.stringify(currentUser));
                initApp();
                toggleLoader(false);
            }
        } catch (err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            toggleLoader(false);
        }
    };

    function initApp() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('monitorSection').style.display = 'block';
        document.getElementById('labelName').innerText = currentUser.monitorName || "Ù…Ø±Ø§Ù‚Ø¨";
        document.getElementById('labelCode').innerText = currentUser.code;
        refreshUI();
    }

    async function handleUpdate(field, value, label) {
        toggleLoader(true, `Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ ${label}...`);
        try {
            const data = { [field]: value, lastUpdate: Date.now() };
            await db.collection('monitors').doc(currentUser.docId).update(data);
            
            currentUser[field] = value;
            localStorage.setItem('monitor_user', JSON.stringify(currentUser));
            refreshUI();
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
        } catch (err) {
            alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
        }
        toggleLoader(false);
    }

    function reportIssue() {
        const msg = prompt("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ØªÙˆØ§Ø¬Ù‡Ù‡Ø§:");
        if (msg) handleUpdate('issueMessage', msg, 'Ø§Ù„Ø¨Ù„Ø§Øº');
    }

    function sendLocation() {
        if (!navigator.geolocation) return alert("Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ");
        
        toggleLoader(true, "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª...");
        navigator.geolocation.getCurrentPosition(pos => {
            handleUpdate('location', {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            }, "Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        }, () => {
            toggleLoader(false);
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ");
        });
    }

    async function processPhotos(files) {
        if (!files.length) return;
        toggleLoader(true, "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù„Ø³ÙŠØ±ÙØ±...");
        
        const urls = currentUser.photoList || [];
        try {
            for (let f of files) {
                const path = `evidence/${currentUser.code}/${Date.now()}_${f.name}`;
                const ref = storage.ref(path);
                await ref.put(f);
                const link = await ref.getDownloadURL();
                urls.push(link);
            }
            await handleUpdate('photoList', urls, 'Ø§Ù„ØµÙˆØ±');
        } catch (err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±");
            toggleLoader(false);
        }
    }

    function refreshUI() {
        const box = document.getElementById('summaryUI');
        box.innerHTML = `
            <div style="margin-bottom:5px;">ğŸš© Ø§Ù„ÙˆØµÙˆÙ„: ${currentUser.arrived ? 'ğŸŸ¢ ØªÙ…' : 'âšª Ù„Ù… ÙŠØªÙ…'}</div>
            <div style="margin-bottom:5px;">ğŸ—³ Ø§Ù„ØªØµÙˆÙŠØª: ${currentUser.voted ? 'ğŸ”µ ØªÙ…' : 'âšª Ù„Ù… ÙŠØªÙ…'}</div>
            <div style="margin-bottom:5px;">ğŸ“¸ Ø§Ù„ØµÙˆØ±: ${currentUser.photoList ? currentUser.photoList.length : 0} ØµÙˆØ±</div>
            <div style="color:red; font-size:12px;">âš  Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ${currentUser.issueMessage || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
        `;

        const container = document.getElementById('imgContainer');
        container.innerHTML = '';
        if (currentUser.photoList) {
            currentUser.photoList.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                container.appendChild(img);
            });
        }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = () => {
        const saved = localStorage.getItem('monitor_user');
        if (saved) {
            currentUser = JSON.parse(saved);
            initApp();
        }
    };
</script>

</body>
</html>
