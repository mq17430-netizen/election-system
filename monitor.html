<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ - Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary:#1a9bff; --accent:#00c853; --card-radius:22px; --shadow:0 20px 40px rgba(15,34,58,0.18); }
        *{box-sizing:border-box;margin:0;padding:0;}

        body{
            font-family:'Cairo',sans-serif;
            min-height:100vh;
            background:radial-gradient(circle at top left,#e0f2ff 0,#f7fbff 40%,#e6fff4 100%);
            display:flex;align-items:center;justify-content:center;
        }

        #loginSection{width:100%;max-width:420px;padding:20px;}

        .card{
            background:#fff;border-radius:var(--card-radius);
            box-shadow:var(--shadow);padding:32px 28px 24px;text-align:center;
        }

        .icon-circle{
            width:72px;height:72px;margin:0 auto 16px;border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,#00c853,#1a9bff);color:#fff;font-size:34px;
        }

        h1{font-size:24px;margin-bottom:8px;font-weight:700;}
        .subtitle{color:#777;font-size:14px;margin-bottom:24px;}
        .form-group{text-align:right;margin-bottom:18px;}
        label{font-size:13px;color:#555;margin-bottom:6px;display:block;}

        .input-wrapper{position:relative;}
        .input-wrapper input{
            width:100%;border-radius:12px;border:1px solid #dde3ee;
            padding:11px 40px 11px 12px;font-size:14px;outline:none;
        }
        .input-wrapper input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,132,255,0.08);}
        .input-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:18px;color:#9aa4bc;}

        button.primary{
            width:100%;border:none;border-radius:12px;padding:11px 0;
            font-size:15px;font-weight:600;cursor:pointer;
            background:linear-gradient(90deg,#00c853,#1a9bff,#0066ff);
            color:#fff;box-shadow:0 10px 20px rgba(0,102,255,0.25);
        }

        .error{margin-top:10px;color:#d32f2f;font-size:13px;display:none;}
        .footer{margin-top:18px;font-size:12px;color:#aaa;}

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ */
        #monitorSection{display:none;width:100%;max-width:450px;padding:20px;}

        .monitor-header{text-align:center;margin-bottom:16px;}
        .monitor-header h2{font-size:20px;margin-bottom:4px;}
        .monitor-header p{font-size:13px;color:#777;}

        .btn-action{
            width:100%;border:none;border-radius:14px;padding:12px 0;margin-bottom:10px;
            font-size:15px;font-weight:600;cursor:pointer;color:#fff;
            display:flex;align-items:center;justify-content:center;gap:8px;
        }

        .btn-arrived{background:linear-gradient(90deg,#00c853,#4caf50);}
        .btn-voted{background:linear-gradient(90deg,#1a9bff,#0066ff);}
        .btn-issue{background:linear-gradient(90deg,#ff9800,#f44336);}
        .btn-loc{background:linear-gradient(90deg,#ff9800,#ff5722);}
        .btn-photo{background:linear-gradient(90deg,#7b1fa2,#512da8);}

        .btn-action.inactive{opacity:.5;}

        .status-box{margin-top:14px;font-size:12px;color:#555;text-align:right;line-height:1.6;}
        .status-box span.label{font-weight:600;}
        .photo-preview img{max-width:100%;border-radius:10px;margin-top:4px;}

        input[type="file"]{display:none;}
    </style>
</head>
<body>

<!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ -->
<div id="loginSection">
    <div class="card">
        <div class="icon-circle">ğŸ‘¤</div>
        <h1>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</h1>
        <p class="subtitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</p>

        <form id="monitorLoginForm">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</label>
                <div class="input-wrapper">
                    <span class="input-icon">ğŸ‘¤</span>
                    <input id="monitorName" type="text" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                </div>
            </div>

            <div class="form-group">
                <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</label>
                <div class="input-wrapper">
                    <span class="input-icon">ğŸ”‘</span>
                    <input id="monitorCode" type="password" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯">
                </div>
            </div>

            <button type="submit" class="primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="loginError" class="error">Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</div>
        </form>

        <div class="footer">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø®ØªØ§Ø± Ù‚Ø§Ø³Ù…</div>
    </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ -->
<div id="monitorSection">
    <div class="card">

 document.getElementById("logoutBtn").addEventListener("click", () => {
    // Ø£ÙˆÙ„Ø§Ù‹: Ø¹Ù„Ù‘Ù… Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙŠ localStorage
    if(currentCode){
        localStorage.setItem("online_status_"+currentCode,"offline");
    }

    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¹Ù„Ù‘Ù… Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙŠ Firestore Ø­ØªÙ‰ ØªØ¸Ù‡Ø± "ØºÙŠØ± Ù…ØªØµÙ„" ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if(monitorDocId){
        db.collection("monitors").doc(monitorDocId).update({
            online: false
        }).catch(err => console.error("Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", err));
    }

    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    localStorage.removeItem(LOGIN_FLAG_KEY);
    localStorage.removeItem(LOGIN_CODE_KEY);
    localStorage.removeItem(LOGIN_NAME_KEY);

    currentCode = "";
    monitorDocId = null; // Ù†Ù†Ø³Ø§Ù‡

    loginSection.style.display = "block";
    monitorSection.style.display = "none";
});

        <div class="monitor-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</h2>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="welcomeName">Ù…Ø±Ø§Ù‚Ø¨</span> â€” ÙƒÙˆØ¯Ùƒ: <strong id="welcomeCode"></strong></p>
        </div>

        <button id="btnArrived"  class="btn-action btn-arrived">âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„</button>
        <button id="btnVoted"    class="btn-action btn-voted">ğŸ—³ ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª</button>
        <button id="btnIssue"    class="btn-action btn-issue">âš  Ù…Ø´ÙƒÙ„Ø©</button>
        <button id="btnLocation" class="btn-action btn-loc">ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>

        <label for="photoInput">
            <button class="btn-action btn-photo" type="button">ğŸ“· Ø§Ù„ØªÙ‚Ø§Ø· / Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
        </label>
        <!-- multiple + ÙƒØ§Ù…Ø±Ø© -->
        <input id="photoInput" type="file" accept="image/*" capture="environment" multiple>

        <div class="status-box" id="statusBox">
            <div><span class="label">Ø§Ù„ÙˆØµÙˆÙ„:</span> â€”</div>
            <div><span class="label">Ø§Ù„ØªØµÙˆÙŠØª:</span> â€”</div>
            <div><span class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> â€”</div>
            <div><span class="label">Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</span> â€”</div>
            <div><span class="label">Ø§Ù„ØµÙˆØ±Ø©:</span> â€”</div>
        </div>

        <div class="photo-preview" id="photoPreview"></div>
    </div>
</div>

<!-- Firebase -->
<!-- ØµØ­ -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
  authDomain:"election-system-9cbb8.firebaseapp.com",
  projectId:"election-system-9cbb8",
  storageBucket:"election-system-9cbb8.firebasestorage.app",
  messagingSenderId:"886706894008",
  appId:"1:886706894008:web:270556771843614e56b04d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const MAX_PHOTOS = 20;

async function findMonitorByCodeOnline(code){
    const snap = await db.collection("monitors").where("code","==",code).limit(1).get();
    if(snap.empty) return null;
    const d = snap.docs[0];
    return {id:d.id, ...d.data()};
}

const loginSection=document.getElementById("loginSection");
const monitorSection=document.getElementById("monitorSection");

const loginForm=document.getElementById("monitorLoginForm");
const loginError=document.getElementById("loginError");

const welcomeName=document.getElementById("welcomeName");
const welcomeCode=document.getElementById("welcomeCode");

const btnArrived=document.getElementById("btnArrived");
const btnVoted=document.getElementById("btnVoted");
const btnIssue=document.getElementById("btnIssue");
const btnLocation=document.getElementById("btnLocation");
const photoInput=document.getElementById("photoInput");
const photoPreview=document.getElementById("photoPreview");

let currentCode="";
let currentMonitorId = null;
let photosArray = [];

let statusData={arrived:false,voted:false,hasIssue:false,issueText:"",location:null,photoSent:false};

const STATUS_KEY="monitor_status_";

// âœ… Ù…ÙØ§ØªÙŠØ­ Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
const LOGIN_FLAG_KEY = "monitor_logged_in";
const LOGIN_CODE_KEY = "monitor_logged_code";
const LOGIN_NAME_KEY = "monitor_logged_name";

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Firestore Ø¨Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
function pushStatusToFirestore(extra = {}) {
    if (!currentMonitorId) return;
    const payload = {
        arrived: statusData.arrived,
        voted: statusData.voted,
        hasIssue: statusData.hasIssue,
        issueText: statusData.issueText,
        location: statusData.location || null,
        photoSent: statusData.photoSent,
        online: true,
        photos: photosArray
    };
    Object.assign(payload, extra);
    db.collection("monitors").doc(currentMonitorId).update(payload).catch(err=>{
        console.error("Firestore update error:", err);
    });
}

// âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù„Ø³Ø© Ù…Ø±Ø§Ù‚Ø¨ Ø³Ø§Ø¨Ù‚Ø© (ÙÙŠ Ø­Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©)
(async function restoreMonitorSession(){
    const flag = localStorage.getItem(LOGIN_FLAG_KEY);
    const savedCode = localStorage.getItem(LOGIN_CODE_KEY);
    const savedName = localStorage.getItem(LOGIN_NAME_KEY);

    if(flag === "true" && savedCode){
        const m = await findMonitorByCodeOnline(savedCode);
        if (!m) {
            // Ù„Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø§ Ø¹Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firestore
            localStorage.removeItem(LOGIN_FLAG_KEY);
            localStorage.removeItem(LOGIN_CODE_KEY);
            localStorage.removeItem(LOGIN_NAME_KEY);
            return;
        }

        currentMonitorId = m.id;
        currentCode = savedCode;

        photosArray = Array.isArray(m.photos) ? m.photos.slice(0, MAX_PHOTOS) : [];

        statusData = {
            arrived: !!m.arrived,
            voted: !!m.voted,
            hasIssue: !!m.hasIssue,
            issueText: m.issueText || "",
            location: m.location || null,
            photoSent: photosArray.length > 0
        };

        const saved = localStorage.getItem(STATUS_KEY + currentCode);
        if(saved){
            try{ 
                const local = JSON.parse(saved);
                // Ù†Ø¯Ù…Ø¬ Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ·
                if (typeof local.arrived === "boolean") statusData.arrived = local.arrived;
                if (typeof local.voted === "boolean")   statusData.voted   = local.voted;
                if (typeof local.hasIssue === "boolean")statusData.hasIssue= local.hasIssue;
                if (typeof local.issueText === "string")statusData.issueText= local.issueText;
                if (local.location) statusData.location = local.location;
                if (typeof local.photoSent === "boolean") statusData.photoSent = local.photoSent;
            }catch(e){}
        }

        welcomeName.textContent = savedName || m.monitorName || "Ù…Ø±Ø§Ù‚Ø¨";
        welcomeCode.textContent = currentCode;

        loginSection.style.display = "none";
        monitorSection.style.display = "block";

        // Ø§Ø¹ØªØ¨Ø±Ù‡ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹
        localStorage.setItem("online_status_"+currentCode,"online");
        pushStatusToFirestore({online:true});
        updateUI();
    }
})();

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
loginForm.addEventListener("submit", async e => {
    e.preventDefault();

    const name = document.getElementById("monitorName").value.trim();
    const code = document.getElementById("monitorCode").value.trim().toUpperCase();

    // ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Firestore
    const m = await findMonitorByCodeOnline(code);
    if (!m) {
        loginError.style.display = "block";
        return;
    }

    loginError.style.display = "none";
    currentCode = code;
    currentMonitorId = m.id;

    // ğŸ“¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®Ø²Ù‘Ù†Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
    photosArray = Array.isArray(m.photos) ? m.photos.slice(0, MAX_PHOTOS) : [];

    // ğŸ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
    statusData = {
        arrived: !!m.arrived,
        voted: !!m.voted,
        hasIssue: !!m.hasIssue,
        issueText: m.issueText || "",
        location: m.location || null,
        photoSent: photosArray.length > 0
    };

    // ğŸ“Œ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
    welcomeName.textContent = name || m.monitorName || "Ù…Ø±Ø§Ù‚Ø¨";
    welcomeCode.textContent = currentCode;

    // ğŸ”„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    loginSection.style.display = "none";
    monitorSection.style.display = "block";

    // ğŸŸ¢ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø£Ù†Ù‡ ONLINE ÙÙŠ Local
    localStorage.setItem("online_status_" + currentCode, "online");

    // ğŸŸ¢ ØªØ­Ø¯ÙŠØ« Firestore â†’ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø£ØµØ¨Ø­ Ù…ØªØµÙ„Ø§Ù‹
    if (currentMonitorId) {
        db.collection("monitors").doc(currentMonitorId).update({
            online: true
        }).catch(err => console.error("Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:", err));
    }

    // ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    localStorage.setItem(LOGIN_FLAG_KEY, "true");
    localStorage.setItem(LOGIN_CODE_KEY, currentCode);
    localStorage.setItem(LOGIN_NAME_KEY, welcomeName.textContent);

    // ğŸ” Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Firestore
    pushStatusToFirestore({
        arrived: statusData.arrived,
        voted: statusData.voted,
        hasIssue: statusData.hasIssue,
        issueText: statusData.issueText,
        location: statusData.location,
        photos: photosArray,
        online: true
    });

    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateUI();
});
    
});

// Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click",()=>{
    if(currentCode){
        localStorage.setItem("online_status_"+currentCode,"offline");
    }
    if (currentMonitorId) {
        db.collection("monitors").doc(currentMonitorId).update({online:false}).catch(()=>{});
    }
    // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    localStorage.removeItem(LOGIN_FLAG_KEY);
    localStorage.removeItem(LOGIN_CODE_KEY);
    localStorage.removeItem(LOGIN_NAME_KEY);

    currentCode = "";
    currentMonitorId = null;
    loginSection.style.display = "block";
    monitorSection.style.display = "none";
});

// ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø¹Ø±Ø¶
document.querySelector(".btn-photo").addEventListener("click",()=>{
    photoInput.click();
});

// Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ localStorage (Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·)
function saveStatus(){
    if(!currentCode) return;
    try{
        localStorage.setItem(STATUS_KEY+currentCode,JSON.stringify(statusData));
    }catch(e){
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©.");
    }
}

function updateUI(){
    const lines=document.querySelectorAll("#statusBox div");
    lines[0].innerHTML=`<span class="label">Ø§Ù„ÙˆØµÙˆÙ„:</span> ${statusData.arrived?"ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„":"â€”"}`;
    lines[1].innerHTML=`<span class="label">Ø§Ù„ØªØµÙˆÙŠØª:</span> ${statusData.voted?"ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª":"â€”"}`;
    lines[2].innerHTML=`<span class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> ${
        statusData.location?statusData.location.lat.toFixed(6)+", "+statusData.location.lng.toFixed(6):"â€”"
    }`;
    lines[3].innerHTML=`<span class="label">Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</span> ${
        statusData.hasIssue?(statusData.issueText||"Ù…Ø´ÙƒÙ„Ø©"): "â€”"
    }`;
    lines[4].innerHTML=`<span class="label">Ø§Ù„ØµÙˆØ±Ø©:</span> ${statusData.photoSent?"ğŸ“· Ù…ÙˆØ¬ÙˆØ¯Ø©":"â€”"}`;
}

btnArrived.onclick=()=>{
    statusData.arrived=!statusData.arrived;
    saveStatus();
    updateUI();
    pushStatusToFirestore();
};

btnVoted.onclick=()=>{
    statusData.voted=!statusData.voted;
    saveStatus();
    updateUI();
    pushStatusToFirestore();
};

btnIssue.onclick=()=>{
    if(!statusData.hasIssue){
        const t=prompt("ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:");
        if(t){
            statusData.hasIssue=true;
            statusData.issueText=t.trim();
            saveStatus();updateUI();
            pushStatusToFirestore();
        }
    }else{
        const ok=confirm("Ø¥Ù„ØºØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ");
        if(!ok) return;
        statusData.hasIssue=false;
        statusData.issueText="";
        saveStatus();updateUI();
        pushStatusToFirestore();
    }
};

// Ø²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¹ high accuracy
btnLocation.onclick=()=>{
    if(!navigator.geolocation){
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos=>{
            statusData.location={
                lat:pos.coords.latitude,
                lng:pos.coords.longitude
            };
            saveStatus();updateUI();
            if(currentCode){
                try{
                    localStorage.setItem("monitor_location_"+currentCode,JSON.stringify(statusData.location));
                }catch(e){}
            }
            pushStatusToFirestore();
        },
        (err)=>{
            console.error("Geolocation error:",err);
            alert("ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        },
        {
            enableHighAccuracy: true,
            timeout: 20000,
            maximumAge: 0
        }
    );
};

// Ø­ÙØ¸ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Firestore + localStorage
function saveOnePhoto(dataUrl){
    if(!currentCode) return;
    const baseKey = "monitor_photo_"+currentCode;

    // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù„Ø§Ù‚ÙŠ Ø§ÙˆÙ‘Ù„ Ø®Ø§Ù†Ø© ÙØ§Ø¶ÙŠØ© ÙÙŠ localStorage (Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    let slot = -1;
    for(let i=1;i<=MAX_PHOTOS;i++){
        if(!localStorage.getItem(baseKey+"_"+i)){
            slot = i;
            break;
        }
    }

    if(slot === -1){
        try{
            for(let i=1;i<MAX_PHOTOS;i++){
                const next = localStorage.getItem(baseKey+"_"+(i+1));
                if(next){
                    localStorage.setItem(baseKey+"_"+i,next);
                }
            }
            slot = MAX_PHOTOS;
        }catch(e){
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©.");
            return;
        }
    }

    try{
        localStorage.setItem(baseKey+"_"+slot,dataUrl);
        localStorage.setItem(baseKey,dataUrl);
    }catch(e){
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©.");
    }

    // Ø§Ù„Ø¢Ù† Ù†Ø­ÙØ¸ ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± Ø§Ù„ØªÙŠ Ø³ØªØ°Ù‡Ø¨ Ù„Ù€ Firestore
    photosArray.push(dataUrl);
    if (photosArray.length > MAX_PHOTOS) {
        photosArray = photosArray.slice(-MAX_PHOTOS);
    }
    statusData.photoSent = photosArray.length > 0;
    pushStatusToFirestore();
}

// Ù„Ù…Ø§ ÙŠØ®ØªØ§Ø± ØµÙˆØ± (ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±)
photoInput.addEventListener("change",function(){
    const files = Array.from(this.files || []);
    if(!files.length) return;

    files.forEach(file=>{
        const reader=new FileReader();
        reader.onload=e=>{
            statusData.photoSent=true;
            saveOnePhoto(e.target.result);
            saveStatus();updateUI();
            photoPreview.innerHTML=`<img src="${e.target.result}" />`;
        };
        reader.readAsDataURL(file);
    });

    this.value = "";
});

// Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ù†Ø¹Ù„Ù‘Ù… Ø£Ù†Ù‡ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
window.addEventListener("beforeunload",()=>{
    if(currentCode){
        localStorage.setItem("online_status_"+currentCode,"offline");
    }
    if (currentMonitorId) {
        db.collection("monitors").doc(currentMonitorId).update({online:false}).catch(()=>{});
    }
});
</script>

</body>
</html>
