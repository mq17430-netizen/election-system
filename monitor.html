<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Configuration -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        
        // Firebase Configuration - Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyDdiudUa5jjcZDwJgYBbLdC-YBNQ5rlqvU",
            authDomain: "election-system-9cbb8.firebaseapp.com",
            projectId: "election-system-9cbb8",
            storageBucket: "election-system-9cbb8.firebasestorage.app",
            messagingSenderId: "886706894008",
            appId: "1:886706894008:web:270556771843614e56b04d"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Export to global scope
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        
        console.log('Firebase initialized successfully');
    </script>
    
    <style>
        :root {
            --primary: #1a9bff;
            --primary-dark: #0066ff;
            --success: #00c853;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
            --secondary: #9c27b0;
            --dark: #263238;
            --light: #f8f9fa;
            --gray: #78909c;
            --border: #e0e0e0;
            --radius: 16px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            padding: 30px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 10px 30px rgba(26, 155, 255, 0.4);
        }

        h1 {
            color: var(--dark);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 155, 255, 0.1);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 10px 25px rgba(26, 155, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            box-shadow: 0 10px 25px rgba(0, 200, 83, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c62828);
            color: white;
            box-shadow: 0 10px 25px rgba(244, 67, 54, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
            box-shadow: 0 10px 25px rgba(255, 152, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #7b1fa2);
            color: white;
            box-shadow: 0 10px 25px rgba(156, 39, 176, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #1976d2);
            color: white;
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }

        .user-info h2 {
            color: var(--dark);
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-code {
            color: var(--gray);
            font-size: 14px;
            background: var(--light);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .status-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-card {
            background: var(--light);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .status-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }

        .status-label {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .status-panel {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-key {
            color: var(--gray);
            font-size: 14px;
        }

        .status-value {
            font-weight: 600;
            color: var(--dark);
        }

        .status-online { color: var(--success); }
        .status-offline { color: var(--danger); }
        .status-arrived { color: var(--success); }
        .status-not-arrived { color: var(--danger); }
        .status-voted { color: var(--success); }
        .status-not-voted { color: var(--danger); }

        .logout-btn {
            background: none;
            color: var(--gray);
            border: 2px solid var(--border);
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: var(--light);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: var(--dark);
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .modal-close:hover {
            background: var(--light);
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
            background: var(--light);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 155, 255, 0.1);
            background: white;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .form-actions .btn {
            flex: 1;
            margin: 0;
        }

        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader {
            border: 5px solid var(--light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            border-right: 4px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-color: var(--success);
        }

        .notification.error {
            border-color: var(--danger);
        }

        .notification.warning {
            border-color: var(--warning);
        }

        .notification.info {
            border-color: var(--info);
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification.success .notification-icon { color: var(--success); }
        .notification.error .notification-icon { color: var(--danger); }
        .notification.warning .notification-icon { color: var(--warning); }
        .notification.info .notification-icon { color: var(--info); }

        .notification-content h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .notification-content p {
            font-size: 13px;
            color: var(--gray);
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .connection-online {
            color: var(--success);
        }

        .connection-offline {
            color: var(--danger);
        }

        @media (max-width: 480px) {
            .card {
                padding: 20px;
            }
            
            .status-cards {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <p style="margin-top: 20px; color: var(--dark); font-weight: 600;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
</div>

<!-- Login Section -->
<div class="app-container" id="loginSection">
    <div class="card">
        <div class="login-header">
            <div class="login-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª</h1>
            <p class="subtitle">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</p>
        </div>

        <div class="form-group">
            <label class="form-label" for="uCode">
                <i class="fas fa-key"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            </label>
            <input type="password" id="uCode" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ" required>
        </div>

        <button class="btn btn-primary" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>

        <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 12px;">
            <p style="font-size: 12px; color: var(--gray); text-align: center; line-height: 1.6;">
                <i class="fas fa-info-circle"></i> ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….
            </p>
        </div>
    </div>
</div>

<!-- Monitor Section -->
<div class="app-container" id="monitorSection" style="display: none;">
    <div class="card">
        <!-- User Header -->
        <div class="user-header">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-info">
                <h2 id="labelName">Ù…Ø±Ø§Ù‚Ø¨</h2>
                <div class="user-code">
                    <i class="fas fa-id-card"></i> ÙƒÙˆØ¯: <span id="labelCode">0000</span>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="status-cards">
            <div class="status-card">
                <div class="status-icon" id="arrivalIcon">âŒ</div>
                <div class="status-value" id="arrivalStat">Ù„Ù… ÙŠØªÙ…</div>
                <div class="status-label">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
            </div>
            <div class="status-card">
                <div class="status-icon" id="votingIcon">âŒ</div>
                <div class="status-value" id="votingStat">Ù„Ù… ÙŠØªÙ…</div>
                <div class="status-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-success" onclick="updateArrival()">
                <i class="fas fa-check-circle"></i> âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²
            </button>
            
            <button class="btn btn-primary" onclick="updateVoting()">
                <i class="fas fa-vote-yea"></i> ğŸ—³ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØµÙˆÙŠØª
            </button>
            
            <button class="btn btn-danger" onclick="openIssueModal()">
                <i class="fas fa-exclamation-triangle"></i> âš  Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©
            </button>
            
            <button class="btn btn-warning" onclick="sendLocation()">
                <i class="fas fa-map-marker-alt"></i> ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
            </button>
            
            <button class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
                <i class="fas fa-camera"></i> ğŸ“· Ø±ÙØ¹ ØµÙˆØ± ØªÙˆØ«ÙŠÙ‚ÙŠØ©
            </button>
            
            <input type="file" id="photoInput" hidden accept="image/*" onchange="uploadPhoto()">
        </div>

        <!-- Photo Preview -->
        <div id="photoPreview" style="display: none;">
            <img id="previewImage" class="photo-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--gray);">
                <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-item">
                <span class="status-key">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²:</span>
                <span class="status-value status-not-arrived" id="arrivalStatus">Ù„Ù… ÙŠØªÙ…</span>
            </div>
            <div class="status-item">
                <span class="status-key">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª:</span>
                <span class="status-value status-not-voted" id="votingStatus">Ù„Ù… ÙŠØªÙ…</span>
            </div>
            <div class="status-item">
                <span class="status-key">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
                <span class="status-value" id="lastUpdate">--:--</span>
            </div>
            <div class="status-item">
                <span class="status-key">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</span>
                <span class="status-value">
                    <span class="connection-status" id="connectionStatus">
                        <i class="fas fa-wifi"></i> Ù…ØªØµÙ„
                    </span>
                </span>
            </div>
        </div>

        <!-- Logout Button -->
        <button class="btn logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>
    </div>
</div>

<!-- Issue Modal -->
<div class="modal-overlay" id="issueModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-circle"></i> Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h3>
            <button class="modal-close" onclick="closeIssueModal()">Ã—</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
            <select id="issueType" class="form-input" style="padding: 12px 15px;">
                <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</option>
                <option value="ØªØ£Ø®ÙŠØ±">ØªØ£Ø®ÙŠØ± ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</option>
                <option value="Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©">Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø¢Ù„Ø§Øª</option>
                <option value="Ø§Ø²Ø¯Ø­Ø§Ù…">Ø§Ø²Ø¯Ø­Ø§Ù… Ø´Ø¯ÙŠØ¯</option>
                <option value="ØªØ²ÙˆÙŠØ±">Ù…Ø®Ø§Ù„ÙØ©/ØªØ²ÙˆÙŠØ± Ù…Ø´ØªØ¨Ù‡ Ø¨Ù‡</option>
                <option value="Ø£Ù…Ù†ÙŠ">Ù…Ø´ÙƒÙ„Ø© Ø£Ù…Ù†ÙŠØ©</option>
                <option value="Ø£Ø®Ø±Ù‰">Ù…Ø´ÙƒÙ„Ø© Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
            <textarea id="issueDetails" placeholder="Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..."></textarea>
        </div>
        
        <div class="form-actions">
            <button class="btn btn-danger" onclick="submitIssue()">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº
            </button>
            <button class="btn" style="background: var(--light); color: var(--gray);" onclick="closeIssueModal()">
                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>
</div>

<script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let currentUser = null;
    let monitorData = {};
    let isConnected = true;
    let lastUpdateTime = null;
    let locationInterval = null;
    let statusUpdateInterval = null;

    // ====== Ù†Ø¸Ø§Ù… Firebase ======
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Firebase Functions
    async function getFirebaseFunctions() {
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const { 
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            addDoc,
            serverTimestamp,
            onSnapshot,
            Timestamp
        } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
        
        const {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js");
        
        const db = window.firebaseDB || getFirestore();
        const storage = window.firebaseStorage || getStorage();
        
        return {
            db,
            storage,
            collection, query, where, getDocs,
            doc, getDoc, setDoc, updateDoc, addDoc,
            serverTimestamp, onSnapshot, Timestamp,
            ref, uploadBytes, getDownloadURL
        };
    }

    // ====== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ======

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Firebase
    async function login() {
        const code = document.getElementById('uCode').value.trim();
        
        if (!code) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¸Ø§Ø¦Ù Firebase
            const { 
                db, 
                collection, 
                query, 
                where, 
                getDocs,
                doc,
                getDoc
            } = await getFirebaseFunctions();
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙÙŠ Firestore
            const monitorsRef = collection(db, 'monitors');
            const q = query(monitorsRef, where("code", "==", code));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                showNotification('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„', 'error');
                showLoading(false);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                if (code === 'TEST001') {
                    await useTestData(code);
                }
                return;
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            const monitorDoc = querySnapshot.docs[0];
            const monitor = monitorDoc.data();
            
            currentUser = {
                id: monitorDoc.id,
                code: monitor.code,
                name: monitor.name,
                phone: monitor.phone,
                center: monitor.center,
                centerId: monitor.centerId,
                role: monitor.role || 'monitor'
            };
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            await loadMonitorStatus();
            
            // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('monitorSection').style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUI();
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            startRealtimeUpdates();
            
            showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`, 'success');
            
        } catch (error) {
            console.error('Login error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        }
        
        showLoading(false);
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    async function useTestData(code) {
        const testUser = {
            id: 'test_' + Date.now(),
            code: code,
            name: 'Ù…Ø±Ø§Ù‚Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ',
            phone: '07700000000',
            center: 'Ù…Ø±ÙƒØ² ØªØ¬Ø±ÙŠØ¨ÙŠ',
            centerId: 'test_center',
            role: 'monitor'
        };
        
        currentUser = testUser;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        monitorData = {
            ...testUser,
            arrived: false,
            voted: false,
            hasIssue: false,
            location: null,
            lastUpdate: null,
            isOnline: true
        };
        
        // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('monitorSection').style.display = 'block';
        
        updateUI();
        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${testUser.name} (ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)`, 'success');
    }

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ù…Ù† Firebase
    async function loadMonitorStatus() {
        try {
            const { db, doc, getDoc, serverTimestamp, setDoc } = await getFirebaseFunctions();
            
            const statusRef = doc(db, 'status', currentUser.id);
            const statusDoc = await getDoc(statusRef);
            
            if (statusDoc.exists()) {
                const data = statusDoc.data();
                monitorData = {
                    ...currentUser,
                    arrived: data.arrived || false,
                    voted: data.voted || false,
                    hasIssue: data.hasIssue || false,
                    location: data.location || null,
                    lastUpdate: data.lastUpdate?.toDate() || null,
                    isOnline: true
                };
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
                monitorData = {
                    ...currentUser,
                    arrived: false,
                    voted: false,
                    hasIssue: false,
                    location: null,
                    lastUpdate: null,
                    isOnline: true
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                await setDoc(statusRef, {
                    ...monitorData,
                    lastUpdate: serverTimestamp(),
                    createdAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    // ====== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ======

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„
    async function updateArrival() {
        await updateStatus('arrived', true, 'Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø±ÙƒØ²');
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª
    async function updateVoting() {
        await updateStatus('voted', true, 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª');
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Firebase
    async function updateStatus(field, value, label) {
        if (!currentUser) return;
        
        showLoading(true);
        
        try {
            const { 
                db, 
                doc, 
                updateDoc, 
                serverTimestamp, 
                collection, 
                addDoc 
            } = await getFirebaseFunctions();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            monitorData[field] = value;
            monitorData.lastUpdate = new Date();
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUI();
            
            // ØªØ­Ø¯ÙŠØ« Firebase
            const statusRef = doc(db, 'status', currentUser.id);
            await updateDoc(statusRef, {
                [field]: value,
                lastUpdate: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
            const activityRef = collection(db, 'activities');
            await addDoc(activityRef, {
                monitorId: currentUser.id,
                monitorName: monitorData.name,
                monitorCode: monitorData.code,
                action: field,
                value: value,
                label: label,
                timestamp: serverTimestamp(),
                center: monitorData.center
            });
            
            showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${label} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            
        } catch (error) {
            console.error('Update error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
        }
        
        showLoading(false);
    }

    // ====== Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ======

    function openIssueModal() {
        document.getElementById('issueModal').style.display = 'flex';
    }

    function closeIssueModal() {
        document.getElementById('issueModal').style.display = 'none';
        document.getElementById('issueType').value = '';
        document.getElementById('issueDetails').value = '';
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¥Ù„Ù‰ Firebase
    async function submitIssue() {
        const type = document.getElementById('issueType').value;
        const details = document.getElementById('issueDetails').value.trim();
        
        if (!type) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
            return;
        }
        
        if (!details) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            const { 
                db, 
                collection, 
                addDoc, 
                serverTimestamp,
                doc,
                updateDoc
            } = await getFirebaseFunctions();
            
            const issueData = {
                monitorId: currentUser.id,
                monitorName: monitorData.name,
                monitorCode: monitorData.code,
                monitorPhone: monitorData.phone,
                monitorCenter: monitorData.center,
                issueType: type,
                issueDetails: details,
                priority: ['ØªØ²ÙˆÙŠØ±', 'Ø£Ù…Ù†ÙŠ'].includes(type) ? 'high' : 'medium',
                status: 'new',
                timestamp: serverTimestamp(),
                location: monitorData.location || null,
                read: false,
                resolved: false
            };
            
            const issuesRef = collection(db, 'issues');
            await addDoc(issuesRef, issueData);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            monitorData.hasIssue = true;
            const statusRef = doc(db, 'status', currentUser.id);
            await updateDoc(statusRef, {
                hasIssue: true,
                lastUpdate: serverTimestamp()
            });
            
            showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­', 'success');
            closeIssueModal();
            updateUI();
            
        } catch (error) {
            console.error('Issue submission error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº', 'error');
        }
        
        showLoading(false);
    }

    // ====== Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ======

    async function sendLocation() {
        if (!navigator.geolocation) {
            showNotification('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
            return;
        }
        
        showLoading(true);
        
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const { 
                        db, 
                        doc, 
                        updateDoc, 
                        serverTimestamp,
                        collection,
                        addDoc
                    } = await getFirebaseFunctions();
                    
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨
                    monitorData.location = location;
                    monitorData.lastUpdate = location.timestamp;
                    
                    // ØªØ­Ø¯ÙŠØ« Firebase
                    const statusRef = doc(db, 'status', currentUser.id);
                    await updateDoc(statusRef, {
                        location: location,
                        lastUpdate: serverTimestamp(),
                        lastLocationUpdate: serverTimestamp()
                    });
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
                    const locationRef = collection(db, 'locations');
                    await addDoc(locationRef, {
                        monitorId: currentUser.id,
                        monitorName: monitorData.name,
                        monitorCode: monitorData.code,
                        location: location,
                        timestamp: serverTimestamp(),
                        center: monitorData.center
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    updateUI();
                    
                    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                } catch (error) {
                    console.error('Location save error:', error);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                }
                
                showLoading(false);
            },
            (error) => {
                console.error('Geolocation error:', error);
                
                let message = 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
                        break;
                    case error.TIMEOUT:
                        message = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                        break;
                }
                
                showNotification(message, 'error');
                showLoading(false);
            },
            options
        );
    }

    // ====== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ======

    async function uploadPhoto() {
        const input = document.getElementById('photoInput');
        if (!input.files.length) return;
        
        const file = input.files[0];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
        if (!file.type.startsWith('image/')) {
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            const { 
                storage, 
                ref, 
                uploadBytes, 
                getDownloadURL, 
                db, 
                collection, 
                addDoc, 
                serverTimestamp 
            } = await getFirebaseFunctions();
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù„Ù
            const fileName = `${currentUser.id}_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, `photos/${fileName}`);
            
            // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            document.getElementById('previewImage').src = downloadURL;
            document.getElementById('photoPreview').style.display = 'block';
            
            // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Firestore
            const photoInfo = {
                monitorId: currentUser.id,
                monitorName: monitorData.name,
                monitorCode: monitorData.code,
                photoURL: downloadURL,
                fileName: fileName,
                timestamp: serverTimestamp(),
                type: file.type,
                size: file.size,
                center: monitorData.center
            };
            
            const photosRef = collection(db, 'photos');
            await addDoc(photosRef, photoInfo);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            if (!monitorData.photos) monitorData.photos = [];
            monitorData.photos.push(photoInfo);
            
            showNotification('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
        } catch (error) {
            console.error('Photo upload error:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
        }
        
        showLoading(false);
    }

    // ====== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ======

    function startMonitoring() {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
        updateConnectionStatus();
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        statusUpdateInterval = setInterval(() => {
            updateConnectionStatus();
            updateOnlineStatus();
            checkForAdminMessages();
        }, 5000);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø°Ø§ Ø³Ù…Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (navigator.geolocation) {
            locationInterval = setInterval(() => {
                updateLocationPeriodically();
            }, 60000);
        }
    }

    function updateConnectionStatus() {
        const online = navigator.onLine;
        
        if (online !== isConnected) {
            isConnected = online;
            
            const statusEl = document.getElementById('connectionStatus');
            if (online) {
                statusEl.innerHTML = '<i class="fas fa-wifi"></i> Ù…ØªØµÙ„';
                statusEl.className = 'connection-status connection-online';
                showNotification('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
                
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Firebase
                syncDataWithFirebase();
            } else {
                statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> ØºÙŠØ± Ù…ØªØµÙ„';
                statusEl.className = 'connection-status connection-offline';
                showNotification('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
            }
        }
    }

    async function updateOnlineStatus() {
        if (!currentUser) return;
        
        try {
            const { db, doc, updateDoc, serverTimestamp } = await getFirebaseFunctions();
            
            const statusRef = doc(db, 'status', currentUser.id);
            await updateDoc(statusRef, {
                isOnline: isConnected,
                lastSeen: serverTimestamp()
            });
            
        } catch (error) {
            console.error('Error updating online status:', error);
        }
    }

    async function updateLocationPeriodically() {
        if (!navigator.geolocation || !isConnected || !currentUser) return;
        
        try {
            const { db, doc, updateDoc, serverTimestamp } = await getFirebaseFunctions();
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase
                    const statusRef = doc(db, 'status', currentUser.id);
                    await updateDoc(statusRef, {
                        location: location,
                        lastLocationUpdate: serverTimestamp()
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    monitorData.location = location;
                },
                () => {}, // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                { enableHighAccuracy: false, timeout: 5000, maximumAge: 30000 }
            );
        } catch (error) {
            console.error('Periodic location update error:', error);
        }
    }

    async function syncDataWithFirebase() {
        if (!currentUser) return;
        
        try {
            const { db, doc, setDoc, serverTimestamp } = await getFirebaseFunctions();
            
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ø¹ Firebase
            const statusRef = doc(db, 'status', currentUser.id);
            await setDoc(statusRef, {
                ...monitorData,
                lastUpdate: serverTimestamp(),
                lastSync: serverTimestamp()
            }, { merge: true });
            
            console.log('Data synced with Firebase');
        } catch (error) {
            console.error('Sync error:', error);
        }
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    async function startRealtimeUpdates() {
        if (!currentUser) return;
        
        try {
            const { db, doc, onSnapshot } = await getFirebaseFunctions();
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            const statusRef = doc(db, 'status', currentUser.id);
            onSnapshot(statusRef, (doc) => {
                if (doc.exists()) {
                    const newData = doc.data();
                    monitorData = { ...monitorData, ...newData };
                    updateUI();
                }
            });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
            const messagesRef = collection(db, 'messages');
            const q = query(messagesRef, 
                where("monitorId", "==", currentUser.id),
                where("read", "==", false)
            );
            
            onSnapshot(q, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        showNotification(`Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±: ${message.text}`, 'info');
                        
                        // ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
                        await updateDoc(change.doc.ref, { read: true });
                    }
                });
            });
            
        } catch (error) {
            console.error('Realtime updates error:', error);
        }
    }

    async function checkForAdminMessages() {
        // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ startRealtimeUpdates
    }

    // ====== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======

    function updateUI() {
        if (!monitorData) return;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        document.getElementById('labelName').textContent = monitorData.name || 'Ù…Ø±Ø§Ù‚Ø¨';
        document.getElementById('labelCode').textContent = monitorData.code || '0000';
        document.getElementById('userAvatar').textContent = (monitorData.name || '?').charAt(0);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„
        const arrived = monitorData.arrived || false;
        document.getElementById('arrivalStat').textContent = arrived ? 'ØªÙ…' : 'Ù„Ù… ÙŠØªÙ…';
        document.getElementById('arrivalIcon').textContent = arrived ? 'âœ…' : 'âŒ';
        document.getElementById('arrivalStatus').textContent = arrived ? 'ØªÙ…' : 'Ù„Ù… ÙŠØªÙ…';
        document.getElementById('arrivalStatus').className = arrived ? 
            'status-value status-arrived' : 'status-value status-not-arrived';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª
        const voted = monitorData.voted || false;
        document.getElementById('votingStat').textContent = voted ? 'ØªÙ…' : 'Ù„Ù… ÙŠØªÙ…';
        document.getElementById('votingIcon').textContent = voted ? 'âœ…' : 'âŒ';
        document.getElementById('votingStatus').textContent = voted ? 'ØªÙ…' : 'Ù„Ù… ÙŠØªÙ…';
        document.getElementById('votingStatus').className = voted ? 
            'status-value status-voted' : 'status-value status-not-voted';
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        if (monitorData.lastUpdate) {
            const date = monitorData.lastUpdate instanceof Date ? monitorData.lastUpdate : new Date(monitorData.lastUpdate);
            const timeStr = date.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdate').textContent = timeStr;
        }
    }

    // ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======

    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showNotification(message, type = 'info') {
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
        const oldNotifications = document.querySelectorAll('.notification');
        oldNotifications.forEach(n => n.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-${getNotificationIcon(type)}"></i>
            </div>
            <div class="notification-content">
                <h4>${getNotificationTitle(type)}</h4>
                <p>${message}</p>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    function getNotificationIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    function getNotificationTitle(type) {
        const titles = {
            success: 'Ù†Ø¬Ø§Ø­',
            error: 'Ø®Ø·Ø£',
            warning: 'ØªØ­Ø°ÙŠØ±',
            info: 'Ù…Ø¹Ù„ÙˆÙ…Ø©'
        };
        return titles[type] || 'Ø¥Ø´Ø¹Ø§Ø±';
    }

    // ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ======

    async function logout() {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Firebase
                if (currentUser) {
                    const { db, doc, updateDoc, serverTimestamp } = await getFirebaseFunctions();
                    
                    const statusRef = doc(db, 'status', currentUser.id);
                    await updateDoc(statusRef, {
                        isOnline: false,
                        lastSeen: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            if (locationInterval) clearInterval(locationInterval);
            if (statusUpdateInterval) clearInterval(statusUpdateInterval);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            location.reload();
        }
    }

    // ====== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ======

    window.addEventListener('load', function() {
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            isConnected = true;
            updateConnectionStatus();
        });
        
        window.addEventListener('offline', () => {
            isConnected = false;
            updateConnectionStatus();
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        initializeDefaultData();
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    async function initializeDefaultData() {
        try {
            const { db, collection, getDocs } = await getFirebaseFunctions();
            
            const monitorsRef = collection(db, 'monitors');
            const snapshot = await getDocs(monitorsRef);
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†ØŒ Ø£Ø¶Ù Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            if (snapshot.empty) {
                console.log('No monitors found, you need to add them from Firebase console');
                console.log('You can use code: TEST001 for testing');
            }
        } catch (error) {
            console.log('Firebase not initialized or offline mode');
        }
    }

    // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±ÙŠØ¯
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
</script>
</body>
</html>
